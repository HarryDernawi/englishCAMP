import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, Timestamp, setDoc } from 'firebase/firestore'; // Import setDoc for upsert

import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, PieChart, Pie, Cell } from 'recharts'; // Recharts imports

// Helper function to export data to CSV format
const exportToCsv = (filename, rows) => {
  if (!rows || rows.length === 0) {
    alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§."); // Inform user if no data is available
    return;
  }

  // Generate CSV header from the keys of the first row object
  const header = Object.keys(rows[0]).join(',');
  // Map each row to a CSV line, handling special characters by enclosing in double quotes
  const csv = [
    header,
    ...rows.map(row => Object.values(row).map(value => {
      // Escape double quotes within the value and enclose in double quotes if it contains commas or newlines
      let processedValue = String(value).replace(/"/g, '""');
      if (processedValue.includes(',') || processedValue.includes('\n')) {
        processedValue = `"${processedValue}"`;
      }
      return processedValue;
    }).join(','))
  ].join('\n');

  // Create a Blob object from the CSV string
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  // Create a temporary anchor element to trigger the download
  const link = document.createElement('a');
  if (link.download !== undefined) { // Feature detection for download attribute
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', filename);
    link.style.visibility = 'hidden'; // Hide the link
    document.body.appendChild(link); // Append to body to make it clickable
    link.click(); // Programmatically click the link to trigger download
    document.body.removeChild(link); // Remove the temporary link
  }
};


// ==================================================================================================
// --- COMPONENTS ---
// ==================================================================================================

// DashboardLayout component: Provides the overall structure of the dashboard, including sidebar and header.
const DashboardLayout = ({ children, activeSection, setActiveSection, userId, userRole, setUserRole }) => {
  // Define sidebar items with their icons, text, and roles that can access them
  const sidebarItems = [
    { icon: "ğŸ“Š", text: "Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", section: "dashboard", roles: ['admin'] },
    { icon: "ğŸ§‘â€ğŸ“", text: "Ø§Ù„Ø·Ù„Ø§Ø¨", section: "students", roles: ['admin'] },
    { icon: "ğŸ«", text: "Ø§Ù„ÙØµÙˆÙ„", section: "classes", roles: ['admin'] },
    { icon: "ğŸ“š", text: "Ø§Ù„Ø¯ÙˆØ±Ø§Øª", section: "courses", roles: ['admin'] },
    { icon: "ğŸ’µ", text: "Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª", section: "payments", roles: ['admin'] },
    { icon: "ğŸ’¸", text: "Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ", section: "expenses", roles: ['admin'] },
    { icon: "ğŸ“ˆ", text: "Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±", section: "reports", roles: ['admin'] },
    { icon: "ğŸ‘¨â€ğŸ«", text: "Ø§Ù„Ù…Ø¯Ø±Ø¨ÙˆÙ†", section: "instructors", roles: ['admin'] },
    { icon: "ğŸ—“ï¸", text: "Ø§Ù„Ø­Ø¶ÙˆØ±", section: "attendance", roles: ['admin', 'supervisor'] },
    { icon: "ğŸ“œ", text: "Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª", section: "certificates", roles: ['admin'] },
  ];

  return (
    <div className="flex min-h-screen bg-gray-50 font-sans text-gray-800">
      {/* Sidebar */}
      <aside className="w-64 bg-white shadow-md rounded-lg m-4 p-4 flex flex-col justify-between">
        <div>
          <div className="text-2xl font-bold text-blue-600 mb-8 px-4 py-2 rounded-lg bg-blue-50">
            Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
          </div>
          <nav className="space-y-2">
            {/* Render sidebar items based on the current user's role */}
            {sidebarItems.map(item => (
              (item.roles.includes(userRole)) && ( // Check if the current role is allowed to see this item
                <SidebarItem
                  key={item.section}
                  icon={item.icon}
                  text={item.text}
                  isActive={activeSection === item.section}
                  onClick={() => setActiveSection(item.section)}
                />
              )
            ))}
          </nav>
        </div>
        {userId && (
          <div className="mt-8 p-4 bg-gray-100 rounded-lg text-sm text-gray-600">
            <p className="font-semibold">Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</p>
            <p className="break-all">{userId}</p>
            <div className="mt-2">
              <label htmlFor="role-switcher" className="block text-xs font-medium text-gray-500 mb-1">
                ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ± (Ù„Ù„Ù…Ø­Ø§ÙƒØ§Ø©): {/* Role switcher for demonstration purposes */}
              </label>
              <select
                id="role-switcher"
                value={userRole}
                onChange={(e) => {
                  setUserRole(e.target.value); // Update the user role
                  // Redirect to appropriate section based on the new role
                  if (e.target.value === 'supervisor') {
                    setActiveSection('attendance'); // Supervisors only see attendance
                  } else {
                    setActiveSection('dashboard'); // Admins go to dashboard
                  }
                }}
                className="w-full px-2 py-1 border border-gray-300 rounded-md text-sm"
              >
                <option value="admin">Ø§Ù„Ù…Ø¯ÙŠØ±</option>
                <option value="supervisor">Ø§Ù„Ù…Ø´Ø±Ù</option>
              </select>
            </div>
          </div>
        )}
      </aside>

      {/* Main content area */}
      <main className="flex-1 p-4">
        {/* Header */}
        <header className="bg-white shadow-md rounded-lg p-6 mb-6 flex justify-between items-center">
          <h1 className="text-3xl font-semibold text-gray-700">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ</h1>
          <div className="flex items-center space-x-4">
            {/* Display current user role */}
            <span className="text-gray-600">Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ {userRole === 'admin' ? 'Ø§Ù„Ù…Ø¯ÙŠØ±' : 'Ø§Ù„Ù…Ø´Ø±Ù'}!</span>
          </div>
        </header>

        {/* Dynamic content based on activeSection */}
        <div className="bg-white shadow-md rounded-lg p-6 min-h-[calc(100vh-180px)]">
          {children}
        </div>
      </main>
    </div>
  );
};

// SidebarItem component: Represents a single clickable item in the sidebar.
const SidebarItem = ({ icon, text, isActive, onClick }) => (
  <button
    onClick={onClick}
    className={`flex items-center w-full p-3 rounded-lg text-lg transition-colors duration-200 ${
      isActive
        ? 'bg-blue-100 text-blue-700 font-semibold shadow-sm' // Active state styling
        : 'text-gray-600 hover:bg-gray-100 hover:text-gray-800' // Inactive state styling
    }`}
  >
    <span className="ml-3 text-2xl">{icon}</span> {/* Icon */}
    <span>{text}</span> {/* Text */}
  </button>
);

// DashboardWidget component: A reusable card for displaying key metrics on the dashboard.
const DashboardWidget = ({ title, value, icon, color, children }) => (
  <div className={`p-6 rounded-lg shadow-md flex flex-col items-start ${color}`}>
    <div className="flex items-center justify-between w-full mb-3">
      <span className="text-4xl">{icon}</span> {/* Widget icon */}
      <h3 className="text-xl font-semibold text-gray-700">{title}</h3> {/* Widget title */}
    </div>
    <p className="text-5xl font-bold text-gray-900 mt-2">{value}</p> {/* Widget value */}
    {children} {/* Optional children for additional content like progress bars */}
  </div>
);

// ==================================================================================================
// --- MODALS ---
// ==================================================================================================

// AddStudentModal component: Modal for adding new student records.
const AddStudentModal = ({ onClose, onAddStudent }) => {
  const [name, setName] = useState('');
  const [phone, setPhone] = useState('');
  const [email, setEmail] = useState('');

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (name && phone) {
      await onAddStudent({ name, phone, email, paid: false }); // Add student with default paid status
      onClose(); // Close modal on success
    } else {
      console.error('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ).'); // Error message for missing fields
    }
  };

  return (
    <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
        <h3 className="text-2xl font-semibold mb-6 text-gray-800">Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h3>
        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label htmlFor="studentName" className="block text-sm font-medium text-gray-700 mb-1">
              Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„ÙƒØ§Ù…Ù„:
            </label>
            <input
              type="text"
              id="studentName"
              value={name}
              onChange={(e) => setName(e.target.value)}
              className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨"
              required
            />
          </div>
          <div>
            <label htmlFor="studentPhone" className="block text-sm font-medium text-gray-700 mb-1">
              Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:
            </label>
            <input
              type="tel"
              id="studentPhone"
              value={phone}
              onChange={(e) => setPhone(e.target.value)}
              className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              placeholder="Ù…Ø«Ø§Ù„: 0911234567"
              required
            />
          </div>
          <div>
            <label htmlFor="studentEmail" className="block text-sm font-medium text-gray-700 mb-1">
              Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):
            </label>
            <input
              type="email"
              id="studentEmail"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ"
            />
          </div>
          <div className="flex justify-end space-x-3 mt-6">
            <button
              type="button"
              onClick={onClose}
              className="px-5 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              Ø¥Ù„ØºØ§Ø¡
            </button>
            <button
              type="submit"
              className="px-5 py-2 bg-blue-600 border border-transparent rounded-md shadow-sm text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};

// EditStudentModal component: Modal for editing existing student records.
const EditStudentModal = ({ student, onClose, onUpdateStudent }) => {
  const [name, setName] = useState(student.name);
  const [phone, setPhone] = useState(student.phone);
  const [email, setEmail] = useState(student.email);
  const [paid, setPaid] = useState(student.paid);

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (name && phone) {
      await onUpdateStudent(student.id, { name, phone, email, paid }); // Update student data
      onClose(); // Close modal on success
    } else {
      console.error('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ).'); // Error message for missing fields
    }
  };

  return (
    <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
        <h3 className="text-2xl font-semibold mb-6 text-gray-800">ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</h3>
        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label htmlFor="editStudentName" className="block text-sm font-medium text-gray-700 mb-1">
              Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„ÙƒØ§Ù…Ù„:
            </label>
            <input
              type="text"
              id="editStudentName"
              value={name}
              onChange={(e) => setName(e.target.value)}
              className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨"
              required
            />
          </div>
          <div>
            <label htmlFor="editStudentPhone" className="block text-sm font-medium text-gray-700 mb-1">
              Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:
            </label>
            <input
              type="tel"
              id="editStudentPhone"
              value={phone}
              onChange={(e) => setPhone(e.target.value)}
              className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              placeholder="Ù…Ø«Ø§Ù„: 0911234567"
              required
            />
          </div>
          <div>
            <label htmlFor="editStudentEmail" className="block text-sm font-medium text-gray-700 mb-1">
              Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):
            </label>
            <input
              type="email"
              id="editStudentEmail"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ"
            />
          </div>
          <div className="flex items-center">
            <input
              type="checkbox"
              id="editStudentPaid"
              checked={paid}
              onChange={(e) => setPaid(e.target.checked)}
              className="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
            />
            <label htmlFor="editStudentPaid" className="ml-2 block text-sm font-medium text-gray-700">
              ØªÙ… Ø§Ù„Ø¯ÙØ¹
            </label>
          </div>
          <div className="flex justify-end space-x-3 mt-6">
            <button
              type="button"
              onClick={onClose}
              className="px-5 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              Ø¥Ù„ØºØ§Ø¡
            </button>
            <button
              type="submit"
              className="px-5 py-2 bg-blue-600 border border-transparent rounded-md shadow-sm text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};

// AddClassModal component: Modal for creating new classes.
const AddClassModal = ({ onClose, onAddClass }) => {
  const [name, setName] = useState('');
  const [description, setDescription] = useState('');

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (name) {
      await onAddClass({ name, description }); // Add new class
      onClose(); // Close modal on success
    } else {
      console.error('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø§Ø³Ù… Ø§Ù„ÙØµÙ„.'); // Error message for missing class name
    }
  };

  return (
    <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
        <h3 className="text-2xl font-semibold mb-6 text-gray-800">Ø¥Ù†Ø´Ø§Ø¡ ÙØµÙ„ Ø¬Ø¯ÙŠØ¯</h3>
        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label htmlFor="className" className="block text-sm font-medium text-gray-700 mb-1">
              Ø§Ø³Ù… Ø§Ù„ÙØµÙ„:
            </label>
            <input
              type="text"
              id="className"
              value={name}
              onChange={(e) => setName(e.target.value)}
              className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              placeholder="Ù…Ø«Ø§Ù„: ÙØµÙ„ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª 101"
              required
            />
          </div>
          <div>
            <label htmlFor="classDescription" className="block text-sm font-medium text-gray-700 mb-1">
              Ø§Ù„ÙˆØµÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):
            </label>
            <textarea
              id="classDescription"
              value={description}
              onChange={(e) => setDescription(e.target.value)}
              rows="3"
              className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              placeholder="Ø£Ø¯Ø®Ù„ ÙˆØµÙÙ‹Ø§ Ù…ÙˆØ¬Ø²Ù‹Ø§ Ù„Ù„ÙØµÙ„"
            ></textarea>
          </div>
          <div className="flex justify-end space-x-3 mt-6">
            <button
              type="button"
              onClick={onClose}
              className="px-5 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              Ø¥Ù„ØºØ§Ø¡
            </button>
            <button
              type="submit"
              className="px-5 py-2 bg-blue-600 border border-transparent rounded-md shadow-sm text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙØµÙ„
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};

// EditClassModal component: Modal for editing existing class details.
const EditClassModal = ({ cls, onClose, onUpdateClass }) => {
  const [name, setName] = useState(cls.name);
  const [description, setDescription] = useState(cls.description);

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (name) {
      await onUpdateClass(cls.id, { name, description }); // Update class data
      onClose(); // Close modal on success
    } else {
      console.error('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø§Ø³Ù… Ø§Ù„ÙØµÙ„.'); // Error message for missing class name
    }
  };

  return (
    <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
        <h3 className="text-2xl font-semibold mb-6 text-gray-800">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙØµÙ„</h3>
        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label htmlFor="editClassName" className="block text-sm font-medium text-gray-700 mb-1">
              Ø§Ø³Ù… Ø§Ù„ÙØµÙ„:
            </label>
            <input
              type="text"
              id="editClassName"
              value={name}
              onChange={(e) => setName(e.target.value)}
              className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              placeholder="Ù…Ø«Ø§Ù„: ÙØµÙ„ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª 101"
              required
            />
          </div>
          <div>
            <label htmlFor="editClassDescription" className="block text-sm font-medium text-gray-700 mb-1">
              Ø§Ù„ÙˆØµÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):
            </label>
            <textarea
              id="editClassDescription"
              value={description}
              onChange={(e) => setDescription(e.target.value)}
              rows="3"
              className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              placeholder="Ø£Ø¯Ø®Ù„ ÙˆØµÙÙ‹Ø§ Ù…ÙˆØ¬Ø²Ù‹Ø§ Ù„Ù„ÙØµÙ„"
            ></textarea>
          </div>
          <div className="flex justify-end space-x-3 mt-6">
            <button
              type="button"
              onClick={onClose}
              className="px-5 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              Ø¥Ù„ØºØ§Ø¡
            </button>
            <button
              type="submit"
              className="px-5 py-2 bg-blue-600 border border-transparent rounded-md shadow-sm text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};

// AssignStudentsToClassModal component: Modal for assigning students to a class.
const AssignStudentsToClassModal = ({ cls, students, onClose, onUpdateClass }) => {
  const [selectedStudentIds, setSelectedStudentIds] = useState(cls.students || []); // Initialize with currently assigned students

  const handleCheckboxChange = (studentId) => {
    // Toggle student selection
    setSelectedStudentIds(prevSelected =>
      prevSelected.includes(studentId)
        ? prevSelected.filter(id => id !== studentId) // Remove if already selected
        : [...prevSelected, studentId] // Add if not selected
    );
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    await onUpdateClass(cls.id, { students: selectedStudentIds }); // Update class with new student assignments
    onClose(); // Close modal on success
  };

  return (
    <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
        <h3 className="text-2xl font-semibold mb-6 text-gray-800">ØªÙ†Ø³ÙŠØ¨ Ø·Ù„Ø§Ø¨ Ø¥Ù„Ù‰ ÙØµÙ„: {cls.name}</h3>
        <form onSubmit={handleSubmit} className="space-y-4">
          <div className="max-h-60 overflow-y-auto border border-gray-300 rounded-md p-3">
            {students.length === 0 ? (
              <p className="text-sm text-gray-500">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù…ØªØ§Ø­ÙˆÙ† Ù„Ù„ØªÙ†Ø³ÙŠØ¨.</p>
            ) : (
              students.map(student => (
                <div key={student.id} className="flex items-center mb-2">
                  <input
                    type="checkbox"
                    id={`student-${student.id}`}
                    checked={selectedStudentIds.includes(student.id)}
                    onChange={() => handleCheckboxChange(student.id)}
                    className="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                  />
                  <label htmlFor={`student-${student.id}`} className="ml-2 block text-sm font-medium text-gray-700">
                    {student.name} ({student.email || student.phone})
                  </label>
                </div>
              ))
            )}
          </div>
          <div className="flex justify-end space-x-3 mt-6">
            <button
              type="button"
              onClick={onClose}
              className="px-5 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              Ø¥Ù„ØºØ§Ø¡
            </button>
            <button
              type="submit"
              className="px-5 py-2 bg-blue-600 border border-transparent rounded-md shadow-sm text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};

// AssignInstructorsToClassModal component: Modal for assigning instructors to a class.
const AssignInstructorsToClassModal = ({ cls, instructors, onClose, onUpdateClass }) => {
  const [selectedInstructorIds, setSelectedInstructorIds] = useState(cls.instructors || []); // Initialize with currently assigned instructors

  const handleCheckboxChange = (instructorId) => {
    // Toggle instructor selection
    setSelectedInstructorIds(prevSelected =>
      prevSelected.includes(instructorId)
        ? prevSelected.filter(id => id !== instructorId) // Remove if already selected
        : [...prevSelected, instructorId] // Add if not selected
    );
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    await onUpdateClass(cls.id, { instructors: selectedInstructorIds }); // Update class with new instructor assignments
    onClose(); // Close modal on success
  };

  return (
    <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
        <h3 className="text-2xl font-semibold mb-6 text-gray-800">ØªÙ†Ø³ÙŠØ¨ Ù…Ø¯Ø±Ø¨ÙŠÙ† Ø¥Ù„Ù‰ ÙØµÙ„: {cls.name}</h3>
        <form onSubmit={handleSubmit} className="space-y-4">
          <div className="max-h-60 overflow-y-auto border border-gray-300 rounded-md p-3">
            {instructors.length === 0 ? (
              <p className="text-sm text-gray-500">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¯Ø±Ø¨ÙˆÙ† Ù…ØªØ§Ø­ÙˆÙ† Ù„Ù„ØªÙ†Ø³ÙŠØ¨.</p>
            ) : (
              instructors.map(instructor => (
                <div key={instructor.id} className="flex items-center mb-2">
                  <input
                    type="checkbox"
                    id={`instructor-${instructor.id}`}
                    checked={selectedInstructorIds.includes(instructor.id)}
                    onChange={() => handleCheckboxChange(instructor.id)}
                    className="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                  />
                  <label htmlFor={`instructor-${instructor.id}`} className="ml-2 block text-sm font-medium text-gray-700">
                    {instructor.name} ({instructor.specialty || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ®ØµØµ'})
                  </label>
                </div>
              ))
            )}
          </div>
          <div className="flex justify-end space-x-3 mt-6">
            <button
              type="button"
              onClick={onClose}
              className="px-5 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              Ø¥Ù„ØºØ§Ø¡
            </button>
            <button
              type="submit"
              className="px-5 py-2 bg-blue-600 border border-transparent rounded-md shadow-sm text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};


// AddPaymentModal component: Modal for adding new payment records.
const AddPaymentModal = ({ onClose, onAddPayment, students, courses }) => {
  const [studentId, setStudentId] = useState('');
  const [courseId, setCourseId] = useState('');
  const [amount, setAmount] = useState('');
  const [date, setDate] = useState(new Date().toISOString().split('T')[0]); // Default to current date (YYYY-MM-DD)
  const [discount, setDiscount] = useState('');
  const [status, setStatus] = useState('Ù…Ø¯ÙÙˆØ¹');
  const [notes, setNotes] = useState('');

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (studentId && amount && !isNaN(parseFloat(amount))) { // Validate required fields and amount is a number
      await onAddPayment({
        studentId,
        courseId: courseId || null, // Use null if no course is selected
        amount: parseFloat(amount),
        date: new Date(date), // Convert date string to Date object for Firestore
        discount: parseFloat(discount) || 0, // Default discount to 0 if not provided
        status,
        notes,
      });
      onClose(); // Close modal on success
    } else {
      console.error('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (Ø§Ù„Ø·Ø§Ù„Ø¨ ÙˆØ§Ù„Ù…Ø¨Ù„Øº).'); // Error message for missing fields
    }
  };

  return (
    <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
        <h3 className="text-2xl font-semibold mb-6 text-gray-800">Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label htmlFor="studentSelect" className="block text-sm font-medium text-gray-700 mb-1">
              Ø§Ù„Ø·Ø§Ù„Ø¨:
            </label>
            <select
              id="studentSelect"
              value={studentId}
              onChange={(e) => setStudentId(e.target.value)}
              className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              required
            >
              <option value="">Ø§Ø®ØªØ± Ø·Ø§Ù„Ø¨Ø§Ù‹...</option>
              {students.map(student => (
                <option key={student.id} value={student.id}>
                  {student.name}
                </option>
              ))}
            </select>
          </div>
          <div>
            <label htmlFor="courseSelect" className="block text-sm font-medium text-gray-700 mb-1">
              Ø§Ù„Ø¯ÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):
            </label>
            <select
              id="courseSelect"
              value={courseId}
              onChange={(e) => setCourseId(e.target.value)}
              className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
            >
              <option value="">Ø§Ø®ØªØ± Ø¯ÙˆØ±Ø©...</option>
              {courses.map(course => (
                <option key={course.id} value={course.id}>
                  {course.name} ({course.price.toLocaleString()} Ø¯.Ù„)
                </option>
              ))}
            </select>
          </div>
          <div>
            <label htmlFor="paymentAmount" className="block text-sm font-medium text-gray-700 mb-1">
              Ø§Ù„Ù…Ø¨Ù„Øº (Ø¯.Ù„):
            </label>
            <input
              type="number"
              id="paymentAmount"
              value={amount}
              onChange={(e) => setAmount(e.target.value)}
              className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              placeholder="Ù…Ø«Ø§Ù„: 250.00"
              step="0.01"
              required
            />
          </div>
          <div>
            <label htmlFor="paymentDate" className="block text-sm font-medium text-gray-700 mb-1">
              Ø§Ù„ØªØ§Ø±ÙŠØ®:
            </label>
            <input
              type="date"
              id="paymentDate"
              value={date}
              onChange={(e) => setDate(e.target.value)}
              className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              required
            />
          </div>
          <div>
            <label htmlFor="paymentDiscount" className="block text-sm font-medium text-gray-700 mb-1">
              Ø§Ù„Ø®ØµÙ… (Ø¯.Ù„) (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):
            </label>
            <input
              type="number"
              id="paymentDiscount"
              value={discount}
              onChange={(e) => setDiscount(e.target.value)}
              className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              placeholder="Ù…Ø«Ø§Ù„: 20.00"
              step="0.01"
            />
          </div>
          <div>
            <label htmlFor="paymentStatus" className="block text-sm font-medium text-gray-700 mb-1">
              Ø§Ù„Ø­Ø§Ù„Ø©:
            </label>
            <select
              id="paymentStatus"
              value={status}
              onChange={(e) => setStatus(e.target.value)}
              className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
            >
              <option value="Ù…Ø¯ÙÙˆØ¹">Ù…Ø¯ÙÙˆØ¹</option>
              <option value="Ù…Ø¹Ù„Ù‚">Ù…Ø¹Ù„Ù‚</option>
              <option value="Ø¬Ø²Ø¦ÙŠ">Ø¬Ø²Ø¦ÙŠ</option>
            </select>
          </div>
          <div>
            <label htmlFor="paymentNotes" className="block text-sm font-medium text-gray-700 mb-1">
              Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):
            </label>
            <textarea
              id="paymentNotes"
              value={notes}
              onChange={(e) => setNotes(e.target.value)}
              rows="2"
              className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              placeholder="Ø£Ø¯Ø®Ù„ Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø­ÙˆÙ„ Ø§Ù„Ø¯ÙØ¹Ø©"
            ></textarea>
          </div>
          <div className="flex justify-end space-x-3 mt-6">
            <button
              type="button"
              onClick={onClose}
              className="px-5 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              Ø¥Ù„ØºØ§Ø¡
            </button>
            <button
              type="submit"
              className="px-5 py-2 bg-blue-600 border border-transparent rounded-md shadow-sm text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙØ¹Ø©
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};

// EditPaymentModal component: Modal for editing existing payment records.
const EditPaymentModal = ({ payment, onClose, onUpdatePayment, students, courses }) => {
  // Initialize state with current payment data, converting Timestamp to date string
  const [studentId, setStudentId] = useState(payment.studentId);
  const [courseId, setCourseId] = useState(payment.courseId || '');
  const [amount, setAmount] = useState(payment.amount);
  const [date, setDate] = useState(payment.date.toDate().toISOString().split('T')[0]);
  const [discount, setDiscount] = useState(payment.discount || '');
  const [status, setStatus] = useState(payment.status);
  const [notes, setNotes] = useState(payment.notes || '');

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (studentId && amount && !isNaN(parseFloat(amount))) { // Validate required fields and amount
      await onUpdatePayment(payment.id, {
        studentId,
        courseId: courseId || null,
        amount: parseFloat(amount),
        date: new Date(date), // Convert date string back to Date object
        discount: parseFloat(discount) || 0,
        status,
        notes,
      });
      onClose(); // Close modal on success
    } else {
      console.error('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (Ø§Ù„Ø·Ø§Ù„Ø¨ ÙˆØ§Ù„Ù…Ø¨Ù„Øº).'); // Error message
    }
  };

  return (
    <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
        <h3 className="text-2xl font-semibold mb-6 text-gray-800">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©</h3>
        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label htmlFor="editStudentSelect" className="block text-sm font-medium text-gray-700 mb-1">
              Ø§Ù„Ø·Ø§Ù„Ø¨:
            </label>
            <select
              id="editStudentSelect"
              value={studentId}
              onChange={(e) => setStudentId(e.target.value)}
              className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              required
            >
              <option value="">Ø§Ø®ØªØ± Ø·Ø§Ù„Ø¨Ø§Ù‹...</option>
              {students.map(student => (
                <option key={student.id} value={student.id}>
                  {student.name}
                </option>
              ))}
            </select>
          </div>
          <div>
            <label htmlFor="editCourseSelect" className="block text-sm font-medium text-gray-700 mb-1">
              Ø§Ù„Ø¯ÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):
            </label>
            <select
              id="editCourseSelect"
              value={courseId}
              onChange={(e) => setCourseId(e.target.value)}
              className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
            >
              <option value="">Ø§Ø®ØªØ± Ø¯ÙˆØ±Ø©...</option>
              {courses.map(course => (
                <option key={course.id} value={course.id}>
                  {course.name} ({course.price.toLocaleString()} Ø¯.Ù„)
                </option>
              ))}
            </select>
          </div>
          <div>
            <label htmlFor="editPaymentAmount" className="block text-sm font-medium text-gray-700 mb-1">
              Ø§Ù„Ù…Ø¨Ù„Øº (Ø¯.Ù„):
            </label>
            <input
              type="number"
              id="editPaymentAmount"
              value={amount}
              onChange={(e) => setAmount(e.target.value)}
              className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              placeholder="Ù…Ø«Ø§Ù„: 250.00"
              step="0.01"
              required
            />
          </div>
          <div>
            <label htmlFor="editPaymentDate" className="block text-sm font-medium text-gray-700 mb-1">
              Ø§Ù„ØªØ§Ø±ÙŠØ®:
            </label>
            <input
              type="date"
              id="editPaymentDate"
              value={date}
              onChange={(e) => setDate(e.target.value)}
              className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              required
            />
          </div>
          <div>
            <label htmlFor="editPaymentDiscount" className="block text-sm font-medium text-gray-700 mb-1">
              Ø§Ù„Ø®ØµÙ… (Ø¯.Ù„) (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):
            </label>
            <input
              type="number"
              id="editPaymentDiscount"
              value={discount}
              onChange={(e) => setDiscount(e.target.value)}
              className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              placeholder="Ù…Ø«Ø§Ù„: 20.00"
              step="0.01"
            />
          </div>
          <div>
            <label htmlFor="editPaymentStatus" className="block text-sm font-medium text-gray-700 mb-1">
              Ø§Ù„Ø­Ø§Ù„Ø©:
            </label>
            <select
              id="editPaymentStatus"
              value={status}
              onChange={(e) => setStatus(e.target.value)}
              className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
            >
              <option value="Ù…Ø¯ÙÙˆØ¹">Ù…Ø¯ÙÙˆØ¹</option>
              <option value="Ù…Ø¹Ù„Ù‚">Ù…Ø¹Ù„Ù‚</option>
              <option value="Ø¬Ø²Ø¦ÙŠ">Ø¬Ø²Ø¦ÙŠ</option>
            </select>
          </div>
          <div>
            <label htmlFor="editPaymentNotes" className="block text-sm font-medium text-gray-700 mb-1">
              Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):
            </label>
            <textarea
              id="editPaymentNotes"
              value={notes}
              onChange={(e) => setNotes(e.target.value)}
              rows="2"
              className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              placeholder="Ø£Ø¯Ø®Ù„ Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø­ÙˆÙ„ Ø§Ù„Ø¯ÙØ¹Ø©"
            ></textarea>
          </div>
          <div className="flex justify-end space-x-3 mt-6">
            <button
              type="button"
              onClick={onClose}
              className="px-5 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              Ø¥Ù„ØºØ§Ø¡
            </button>
            <button
              type="submit"
              className="px-5 py-2 bg-blue-600 border border-transparent rounded-md shadow-sm text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};


// AddCourseModal component: Modal for adding new course records.
const AddCourseModal = ({ onClose, onAddCourse }) => {
  const [name, setName] = useState('');
  const [price, setPrice] = useState('');
  const [description, setDescription] = useState('');

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (name && !isNaN(parseFloat(price))) { // Validate name and price is a number
      await onAddCourse({ name, price: parseFloat(price), description });
      onClose(); // Close modal on success
    } else {
      console.error('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ±Ø© ÙˆØ§Ù„Ø³Ø¹Ø±).'); // Error message
    }
  };

  return (
    <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
        <h3 className="text-2xl font-semibold mb-6 text-gray-800">Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label htmlFor="courseName" className="block text-sm font-medium text-gray-700 mb-1">
              Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ±Ø©:
            </label>
            <input
              type="text"
              id="courseName"
              value={name}
              onChange={(e) => setName(e.target.value)}
              className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ±Ø©"
              required
            />
          </div>
          <div>
            <label htmlFor="coursePrice" className="block text-sm font-medium text-gray-700 mb-1">
              Ø§Ù„Ø³Ø¹Ø± (Ø¯.Ù„):
            </label>
            <input
              type="number"
              id="coursePrice"
              value={price}
              onChange={(e) => setPrice(e.target.value)}
              className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              placeholder="Ù…Ø«Ø§Ù„: 500.00"
              step="0.01"
              required
            />
          </div>
          <div>
            <label htmlFor="courseDescription" className="block text-sm font-medium text-gray-700 mb-1">
              Ø§Ù„ÙˆØµÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):
            </label>
            <textarea
              id="courseDescription"
              value={description}
              onChange={(e) => setDescription(e.target.value)}
              rows="3"
              className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              placeholder="Ø£Ø¯Ø®Ù„ ÙˆØµÙÙ‹Ø§ Ù…ÙˆØ¬Ø²Ù‹Ø§ Ù„Ù„Ø¯ÙˆØ±Ø©"
            ></textarea>
          </div>
          <div className="flex justify-end space-x-3 mt-6">
            <button
              type="button"
              onClick={onClose}
              className="px-5 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              Ø¥Ù„ØºØ§Ø¡
            </button>
            <button
              type="submit"
              className="px-5 py-2 bg-blue-600 border border-transparent rounded-md shadow-sm text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙˆØ±Ø©
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};

// EditCourseModal component: Modal for editing existing course details.
const EditCourseModal = ({ course, onClose, onUpdateCourse }) => {
  const [name, setName] = useState(course.name);
  const [price, setPrice] = useState(course.price);
  const [description, setDescription] = useState(course.description);

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (name && !isNaN(parseFloat(price))) { // Validate name and price
      await onUpdateCourse(course.id, { name, price: parseFloat(price), description });
      onClose(); // Close modal on success
    } else {
      console.error('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ±Ø© ÙˆØ§Ù„Ø³Ø¹Ø±).'); // Error message
    }
  };

  return (
    <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
        <h3 className="text-2xl font-semibold mb-6 text-gray-800">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ±Ø©</h3>
        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label htmlFor="editCourseName" className="block text-sm font-medium text-gray-700 mb-1">
              Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ±Ø©:
            </label>
            <input
              type="text"
              id="editCourseName"
              value={name}
              onChange={(e) => setName(e.target.value)}
              className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ±Ø©"
              required
            />
          </div>
          <div>
            <label htmlFor="editCoursePrice" className="block text-sm font-medium text-gray-700 mb-1">
              Ø§Ù„Ø³Ø¹Ø± (Ø¯.Ù„):
            </label>
            <input
              type="number"
              id="editCoursePrice"
              value={price}
              onChange={(e) => setPrice(e.target.value)}
              className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              placeholder="Ù…Ø«Ø§Ù„: 500.00"
              step="0.01"
              required
            />
          </div>
          <div>
            <label htmlFor="editCourseDescription" className="block text-sm font-medium text-gray-700 mb-1">
              Ø§Ù„ÙˆØµÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):
            </label>
            <textarea
              id="editCourseDescription"
              value={description}
              onChange={(e) => setDescription(e.target.value)}
              rows="3"
              className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              placeholder="Ø£Ø¯Ø®Ù„ ÙˆØµÙÙ‹Ø§ Ù…ÙˆØ¬Ø²Ù‹Ø§ Ù„Ù„Ø¯ÙˆØ±Ø©"
            ></textarea>
          </div>
          <div className="flex justify-end space-x-3 mt-6">
            <button
              type="button"
              onClick={onClose}
              className="px-5 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              Ø¥Ù„ØºØ§Ø¡
            </button>
            <button
              type="submit"
              className="px-5 py-2 bg-blue-600 border border-transparent rounded-md shadow-sm text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};

// AddExpenseModal component: Modal for adding new expense records.
const AddExpenseModal = ({ onClose, onAddExpense }) => {
  const [description, setDescription] = useState('');
  const [amount, setAmount] = useState('');
  const [category, setCategory] = useState('');
  const [date, setDate] = useState(new Date().toISOString().split('T')[0]); // Default to current date

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (description && amount && !isNaN(parseFloat(amount))) { // Validate required fields and amount
      await onAddExpense({
        description,
        amount: parseFloat(amount),
        category: category || 'Ø¹Ø§Ù…', // Default category if not selected
        date: new Date(date), // Convert date string to Date object
      });
      onClose(); // Close modal on success
    } else {
      console.error('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (Ø§Ù„ÙˆØµÙ ÙˆØ§Ù„Ù…Ø¨Ù„Øº).'); // Error message
    }
  };

  const categories = ['Ø±ÙˆØ§ØªØ¨', 'Ø¥ÙŠØ¬Ø§Ø±', 'ÙƒÙ‡Ø±Ø¨Ø§Ø¡/Ù…Ø§Ø¡', 'ØµÙŠØ§Ù†Ø©', 'Ù„ÙˆØ§Ø²Ù…', 'ØªØ³ÙˆÙŠÙ‚', 'Ø¹Ø§Ù…']; // Predefined expense categories

  return (
    <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
        <h3 className="text-2xl font-semibold mb-6 text-gray-800">Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ Ø¬Ø¯ÙŠØ¯</h3>
        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label htmlFor="expenseDescription" className="block text-sm font-medium text-gray-700 mb-1">
              Ø§Ù„ÙˆØµÙ:
            </label>
            <input
              type="text"
              id="expenseDescription"
              value={description}
              onChange={(e) => setDescription(e.target.value)}
              className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              placeholder="Ù…Ø«Ø§Ù„: Ø¥ÙŠØ¬Ø§Ø± Ù…Ø¨Ù†Ù‰ Ø§Ù„Ù…Ø±ÙƒØ²"
              required
            />
          </div>
          <div>
            <label htmlFor="expenseAmount" className="block text-sm font-medium text-gray-700 mb-1">
              Ø§Ù„Ù…Ø¨Ù„Øº (Ø¯.Ù„):
            </label>
            <input
              type="number"
              id="expenseAmount"
              value={amount}
              onChange={(e) => setAmount(e.target.value)}
              className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              placeholder="Ù…Ø«Ø§Ù„: 1500.00"
              step="0.01"
              required
            />
          </div>
          <div>
            <label htmlFor="expenseCategory" className="block text-sm font-medium text-gray-700 mb-1">
              Ø§Ù„ÙØ¦Ø©:
            </label>
            <select
              id="expenseCategory"
              value={category}
              onChange={(e) => setCategory(e.target.value)}
              className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
            >
              <option value="">Ø§Ø®ØªØ± ÙØ¦Ø©</option>
              {categories.map(cat => (
                <option key={cat} value={cat}>{cat}</option>
              ))}
            </select>
          </div>
          <div>
            <label htmlFor="expenseDate" className="block text-sm font-medium text-gray-700 mb-1">
              Ø§Ù„ØªØ§Ø±ÙŠØ®:
            </label>
            <input
              type="date"
              id="expenseDate"
              value={date}
              onChange={(e) => setDate(e.target.value)}
              className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              required
            />
          </div>
          <div className="flex justify-end space-x-3 mt-6">
            <button
              type="button"
              onClick={onClose}
              className="px-5 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              Ø¥Ù„ØºØ§Ø¡
            </button>
            <button
              type="submit"
              className="px-5 py-2 bg-blue-600 border border-transparent rounded-md shadow-sm text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØµØ±ÙˆÙ
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};

// EditExpenseModal component: Modal for editing existing expense records.
const EditExpenseModal = ({ expense, onClose, onUpdateExpense }) => {
  // Initialize state with current expense data, converting Timestamp to date string
  const [description, setDescription] = useState(expense.description);
  const [amount, setAmount] = useState(expense.amount);
  const [category, setCategory] = useState(expense.category);
  const [date, setDate] = useState(expense.date.toDate().toISOString().split('T')[0]);

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (description && amount && !isNaN(parseFloat(amount))) { // Validate required fields and amount
      await onUpdateExpense(expense.id, {
        description,
        amount: parseFloat(amount),
        category,
        date: new Date(date), // Convert date string back to Date object
      });
      onClose(); // Close modal on success
    } else {
      console.error('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (Ø§Ù„ÙˆØµÙ ÙˆØ§Ù„Ù…Ø¨Ù„Øº).'); // Error message
    }
  };

  const categories = ['Ø±ÙˆØ§ØªØ¨', 'Ø¥ÙŠØ¬Ø§Ø±', 'ÙƒÙ‡Ø±Ø¨Ø§Ø¡/Ù…Ø§Ø¡', 'ØµÙŠØ§Ù†Ø©', 'Ù„ÙˆØ§Ø²Ù…', 'ØªØ³ÙˆÙŠÙ‚', 'Ø¹Ø§Ù…']; // Predefined expense categories

  return (
    <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
        <h3 className="text-2xl font-semibold mb-6 text-gray-800">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ</h3>
        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label htmlFor="editExpenseDescription" className="block text-sm font-medium text-gray-700 mb-1">
              Ø§Ù„ÙˆØµÙ:
            </label>
            <input
              type="text"
              id="editExpenseDescription"
              value={description}
              onChange={(e) => setDescription(e.target.value)}
              className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              placeholder="Ù…Ø«Ø§Ù„: Ø¥ÙŠØ¬Ø§Ø± Ù…Ø¨Ù†Ù‰ Ø§Ù„Ù…Ø±ÙƒØ²"
              required
            />
          </div>
          <div>
            <label htmlFor="editExpenseAmount" className="block text-sm font-medium text-gray-700 mb-1">
              Ø§Ù„Ù…Ø¨Ù„Øº (Ø¯.Ù„):
            </label>
            <input
              type="number"
              id="editExpenseAmount"
              value={amount}
              onChange={(e) => setAmount(e.target.value)}
              className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              placeholder="Ù…Ø«Ø§Ù„: 1500.00"
              step="0.01"
              required
            />
          </div>
          <div>
            <label htmlFor="editExpenseCategory" className="block text-sm font-medium text-gray-700 mb-1">
              Ø§Ù„ÙØ¦Ø©:
            </label>
            <select
              id="editExpenseCategory"
              value={category}
              onChange={(e) => setCategory(e.target.value)}
              className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
            >
              <option value="">Ø§Ø®ØªØ± ÙØ¦Ø©</option>
              {categories.map(cat => (
                <option key={cat} value={cat}>{cat}</option>
              ))}
            </select>
          </div>
          <div>
            <label htmlFor="editExpenseDate" className="block text-sm font-medium text-gray-700 mb-1">
              Ø§Ù„ØªØ§Ø±ÙŠØ®:
            </label>
            <input
              type="date"
              id="editExpenseDate"
              value={date}
              onChange={(e) => setDate(e.target.value)}
              className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              required
            />
          </div>
          <div className="flex justify-end space-x-3 mt-6">
            <button
              type="button"
              onClick={onClose}
              className="px-5 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              Ø¥Ù„ØºØ§Ø¡
            </button>
            <button
              type="submit"
              className="px-5 py-2 bg-blue-600 border border-transparent rounded-md shadow-sm text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};

// AddInstructorModal component: Modal for adding new instructor records.
const AddInstructorModal = ({ onClose, onAddInstructor, courses }) => {
  const [name, setName] = useState('');
  const [phone, setPhone] = useState('');
  const [email, setEmail] = useState('');
  const [specialty, setSpecialty] = useState('');
  const [courseRates, setCourseRates] = useState({}); // State to hold rates for each course

  // Handler for changing an instructor's rate for a specific course
  const handleRateChange = (courseId, rate) => {
    setCourseRates(prev => ({
      ...prev,
      [courseId]: parseFloat(rate) || 0 // Store as number, default to 0 if invalid
    }));
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (name && phone) { // Validate required fields
      await onAddInstructor({ name, phone, email, specialty, courseRates });
      onClose(); // Close modal on success
    } else {
      console.error('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ).'); // Error message
    }
  };

  return (
    <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
        <h3 className="text-2xl font-semibold mb-6 text-gray-800">Ø¥Ø¶Ø§ÙØ© Ù…Ø¯Ø±Ø¨ Ø¬Ø¯ÙŠØ¯</h3>
        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label htmlFor="instructorName" className="block text-sm font-medium text-gray-700 mb-1">
              Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø¨ Ø§Ù„ÙƒØ§Ù…Ù„:
            </label>
            <input
              type="text"
              id="instructorName"
              value={name}
              onChange={(e) => setName(e.target.value)}
              className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø¨"
              required
            />
          </div>
          <div>
            <label htmlFor="instructorPhone" className="block text-sm font-medium text-gray-700 mb-1">
              Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:
            </label>
            <input
              type="tel"
              id="instructorPhone"
              value={phone}
              onChange={(e) => setPhone(e.target.value)}
              className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              placeholder="Ù…Ø«Ø§Ù„: 0911234567"
              required
            />
          </div>
          <div>
            <label htmlFor="instructorEmail" className="block text-sm font-medium text-gray-700 mb-1">
              Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):
            </label>
            <input
              type="email"
              id="instructorEmail"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ"
            />
          </div>
          <div>
            <label htmlFor="instructorSpecialty" className="block text-sm font-medium text-gray-700 mb-1">
              Ø§Ù„ØªØ®ØµØµ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):
            </label>
            <input
              type="text"
              id="instructorSpecialty"
              value={specialty}
              onChange={(e) => setSpecialty(e.target.value)}
              className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              placeholder="Ù…Ø«Ø§Ù„: Ù„ØºØ© Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©"
            />
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              Ø£Ø¬ÙˆØ± Ø§Ù„Ø¯ÙˆØ±Ø§Øª (Ù„ÙƒÙ„ Ø·Ø§Ù„Ø¨ ÙÙŠ Ø§Ù„Ø¯ÙˆØ±Ø©) (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):
            </label>
            {courses.length === 0 ? (
              <p className="text-sm text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙˆØ±Ø§Øª Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø£Ø¬ÙˆØ± Ù„Ù‡Ø§.</p>
            ) : (
              courses.map(course => (
                <div key={course.id} className="flex items-center mb-2">
                  <label htmlFor={`rate-${course.id}`} className="block text-sm font-medium text-gray-700 w-1/2">
                    {course.name}:
                  </label>
                  <input
                    type="number"
                    id={`rate-${course.id}`}
                    value={courseRates[course.id] || ''}
                    onChange={(e) => handleRateChange(course.id, e.target.value)}
                    className="mt-1 block w-1/2 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                    placeholder="Ø£Ø¬Ø± Ø§Ù„Ø·Ø§Ù„Ø¨"
                    step="0.01"
                  />
                </div>
              ))
            )}
          </div>
          <div className="flex justify-end space-x-3 mt-6">
            <button
              type="button"
              onClick={onClose}
              className="px-5 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              Ø¥Ù„ØºØ§Ø¡
            </button>
            <button
              type="submit"
              className="px-5 py-2 bg-blue-600 border border-transparent rounded-md shadow-sm text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¯Ø±Ø¨
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};

// EditInstructorModal component: Modal for editing existing instructor records.
const EditInstructorModal = ({ instructor, onClose, onUpdateInstructor, courses }) => {
  // Initialize state with current instructor data
  const [name, setName] = useState(instructor.name);
  const [phone, setPhone] = useState(instructor.phone);
  const [email, setEmail] = useState(instructor.email);
  const [specialty, setSpecialty] = useState(instructor.specialty);
  const [courseRates, setCourseRates] = useState(instructor.courseRates || {}); // Initialize with existing rates

  // Handler for changing an instructor's rate for a specific course
  const handleRateChange = (courseId, rate) => {
    setCourseRates(prev => ({
      ...prev,
      [courseId]: parseFloat(rate) || 0
    }));
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (name && phone) { // Validate required fields
      await onUpdateInstructor(instructor.id, { name, phone, email, specialty, courseRates });
      onClose(); // Close modal on success
    } else {
      console.error('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ).'); // Error message
    }
  };

  return (
    <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
        <h3 className="text-2xl font-semibold mb-6 text-gray-800">ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø¨</h3>
        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label htmlFor="editInstructorName" className="block text-sm font-medium text-gray-700 mb-1">
              Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø¨ Ø§Ù„ÙƒØ§Ù…Ù„:
            </label>
            <input
              type="text"
              id="editInstructorName"
              value={name}
              onChange={(e) => setName(e.target.value)}
              className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø¨"
              required
            />
          </div>
          <div>
            <label htmlFor="editInstructorPhone" className="block text-sm font-medium text-gray-700 mb-1">
              Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:
            </label>
            <input
              type="tel"
              id="editInstructorPhone"
              value={phone}
              onChange={(e) => setPhone(e.target.value)}
              className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              placeholder="Ù…Ø«Ø§Ù„: 0911234567"
              required
            />
          </div>
          <div>
            <label htmlFor="editInstructorEmail" className="block text-sm font-medium text-gray-700 mb-1">
              Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):
            </label>
            <input
              type="email"
              id="editInstructorEmail"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ"
            />
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              Ø£Ø¬ÙˆØ± Ø§Ù„Ø¯ÙˆØ±Ø§Øª (Ù„ÙƒÙ„ Ø·Ø§Ù„Ø¨ ÙÙŠ Ø§Ù„Ø¯ÙˆØ±Ø©) (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):
            </label>
            {courses.length === 0 ? (
              <p className="text-sm text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙˆØ±Ø§Øª Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø£Ø¬ÙˆØ± Ù„Ù‡Ø§.</p>
            ) : (
              courses.map(course => (
                <div key={course.id} className="flex items-center mb-2">
                  <label htmlFor={`edit-rate-${course.id}`} className="block text-sm font-medium text-gray-700 w-1/2">
                    {course.name}:
                  </label>
                  <input
                    type="number"
                    id={`edit-rate-${course.id}`}
                    value={courseRates[course.id] || ''}
                    onChange={(e) => handleRateChange(course.id, e.target.value)}
                    className="mt-1 block w-1/2 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                    placeholder="Ø£Ø¬Ø± Ø§Ù„Ø·Ø§Ù„Ø¨"
                    step="0.01"
                  />
                </div>
              ))
            )}
          </div>
          <div className="flex justify-end space-x-3 mt-6">
            <button
              type="button"
              onClick={onClose}
              className="px-5 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              Ø¥Ù„ØºØ§Ø¡
            </button>
            <button
              type="submit"
              className="px-5 py-2 bg-blue-600 border border-transparent rounded-md shadow-sm text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};


// PaymentsPage component: Manages payment records.
const PaymentsPage = ({ payments, addPayment, updatePayment, deletePayment, students, courses }) => {
  const [showAddPaymentModal, setShowAddPaymentModal] = useState(false);
  const [showEditPaymentModal, setShowEditPaymentModal] = useState(false);
  const [currentPayment, setCurrentPayment] = useState(null);

  // Helper function to format Firestore Timestamp dates for display
  const formatDate = (timestamp) => {
    if (!timestamp) return '';
    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
    return date.toLocaleDateString('ar-EG', { year: 'numeric', month: 'short', day: 'numeric' });
  };

  // Helper function to get student name from ID
  const getStudentName = (studentId) => {
    const student = students.find(s => s.id === studentId);
    return student ? student.name : 'Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
  };

  // Helper function to get course name from ID
  const getCourseName = (courseId) => {
    const course = courses.find(c => c.id === courseId);
    return course ? course.name : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙˆØ±Ø© Ù…Ø­Ø¯Ø¯Ø©';
  };

  const handleEditClick = (payment) => {
    setCurrentPayment(payment);
    setShowEditPaymentModal(true);
  };

  const handleDeleteClick = (paymentId) => {
    if (window.confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙØ¹Ø©ØŸ")) {
      deletePayment(paymentId);
    }
  };

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h2 className="text-2xl font-semibold text-gray-700">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</h2>
        <button
          onClick={() => setShowAddPaymentModal(true)}
          className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105"
        >
          + Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©
        </button>
      </div>

      <div className="bg-white rounded-lg shadow-md overflow-hidden">
        <table className="min-w-full divide-y divide-gray-200">
          <thead className="bg-gray-50">
            <tr>
              <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                Ø§Ù„Ø·Ø§Ù„Ø¨
              </th>
              <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                Ø§Ù„Ø¯ÙˆØ±Ø©
              </th>
              <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                Ø§Ù„Ù…Ø¨Ù„Øº
              </th>
              <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                Ø§Ù„Ø®ØµÙ…
              </th>
              <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                Ø§Ù„ØªØ§Ø±ÙŠØ®
              </th>
              <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                Ø§Ù„Ø­Ø§Ù„Ø©
              </th>
              <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                Ù…Ù„Ø§Ø­Ø¸Ø§Øª
              </th>
              <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª
              </th>
            </tr>
          </thead>
          <tbody className="bg-white divide-y divide-gray-200">
            {payments.length === 0 ? (
              <tr>
                <td colSpan="9" className="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">
                  Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¯ÙØ¹Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯.
                </td>
              </tr>
            ) : (
              payments.map((payment) => (
                <tr key={payment.id}>
                  <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                    {getStudentName(payment.studentId)}
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    {getCourseName(payment.courseId)}
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    {payment.amount.toLocaleString()} Ø¯.Ù„
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    {payment.discount.toLocaleString()} Ø¯.Ù„
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    {formatDate(payment.date)}
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm">
                    <span
                      className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                        payment.status === 'Ù…Ø¯ÙÙˆØ¹' ? 'bg-green-100 text-green-800' :
                        payment.status === 'Ù…Ø¹Ù„Ù‚' ? 'bg-red-100 text-red-800' :
                        'bg-yellow-100 text-yellow-800'
                      }`}
                    >
                      {payment.status}
                    </span>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    {payment.notes || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <button
                      onClick={() => handleEditClick(payment)}
                      className="text-blue-600 hover:text-blue-900 ml-4"
                    >
                      ØªØ¹Ø¯ÙŠÙ„
                    </button>
                    <button
                      onClick={() => handleDeleteClick(payment.id)}
                      className="text-red-600 hover:text-red-900"
                    >
                      Ø­Ø°Ù
                    </button>
                  </td>
                </tr>
              ))
            )}
          </tbody>
        </table>
      </div>

      {showAddPaymentModal && (
        <AddPaymentModal onClose={() => setShowAddPaymentModal(false)} onAddPayment={addPayment} students={students} courses={courses} />
      )}

      {showEditPaymentModal && currentPayment && (
        <EditPaymentModal
          payment={currentPayment}
          onClose={() => setShowEditPaymentModal(false)}
          onUpdatePayment={updatePayment}
          students={students}
          courses={courses}
        />
      )}
    </div>
  );
};

// ReportsPage component: Displays various reports and charts.
const ReportsPage = ({ students, classes, expenses, courses, payments }) => {
  const [selectedClassIds, setSelectedClassIds] = useState([]); // State for selected classes for CSV export

  // Financial Overview calculations
  const totalRevenue = payments.reduce((sum, payment) => sum + payment.amount, 0);
  const totalExpenses = expenses.reduce((sum, expense) => sum + expense.amount, 0);
  const netIncome = totalRevenue - totalExpenses;

  // Student Status data for Pie Chart
  const paidStudentsCount = students.filter(s => s.paid).length;
  const unpaidStudentsCount = students.length - paidStudentsCount;
  const studentStatusData = [
    { name: 'Ø·Ù„Ø§Ø¨ Ù…Ø¯ÙÙˆØ¹Ø©', value: paidStudentsCount, color: '#4CAF50' },
    { name: 'Ø·Ù„Ø§Ø¨ ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©', value: unpaidStudentsCount, color: '#F44336' },
  ];

  // Class Enrollment data for Bar Chart
  const classEnrollmentData = classes.map(cls => ({
    name: cls.name,
    students: cls.students ? cls.students.length : 0
  }));

  // Expenses by Category data for Pie Chart
  const expensesByCategory = expenses.reduce((acc, expense) => {
    const category = expense.category || 'ØºÙŠØ± Ù…ØµÙ†Ù';
    acc[category] = (acc[category] || 0) + expense.amount;
    return acc;
  }, {});
  const expensesByCategoryData = Object.entries(expensesByCategory).map(([name, value]) => ({ name, value }));

  // Revenue by Course data for Bar Chart
  const revenueByCourse = payments.reduce((acc, payment) => {
    if (payment.courseId) {
      const course = courses.find(c => c.id === payment.courseId);
      if (course) {
        acc[course.name] = (acc[course.name] || 0) + payment.amount;
      }
    }
    return acc;
  }, {});
  const revenueByCourseData = Object.entries(revenueByCourse).map(([name, value]) => ({ name, value }));

  // Colors for charts
  const COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#8884d8', '#82ca9d', '#ffc658'];

  // Handler for class selection checkboxes for CSV export
  const handleClassSelectionChange = (e) => {
    const { value, checked } = e.target;
    setSelectedClassIds(prev =>
      checked ? [...prev, value] : prev.filter(id => id !== value)
    );
  };

  // Handler for exporting student data by selected classes to CSV
  const handleExportStudentsByClass = () => {
    if (selectedClassIds.length === 0) {
      alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ÙØµÙ„ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨.");
      return;
    }

    const exportedStudents = new Set(); // Use a Set to track unique student IDs to avoid duplicates
    const dataToExport = [];

    selectedClassIds.forEach(classId => {
      const selectedClass = classes.find(cls => cls.id === classId);
      if (selectedClass && selectedClass.students) {
        selectedClass.students.forEach(studentId => {
          if (!exportedStudents.has(studentId)) { // Only add student if not already added
            const student = students.find(s => s.id === studentId);
            if (student) {
              dataToExport.push({
                'Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨': student.name,
                'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ': student.phone,
                'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ': student.email || '',
                'Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹': student.paid ? 'Ù…Ø¯ÙÙˆØ¹' : 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹',
                'Ø§Ù„ÙØµÙ„': selectedClass.name // Include class name for context
              });
              exportedStudents.add(studentId);
            }
          }
        });
      }
    });

    if (dataToExport.length > 0) {
      exportToCsv('student_data_by_class.csv', dataToExport); // Call the CSV export helper
    } else {
      alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ ÙÙŠ Ø§Ù„ÙØµÙˆÙ„ Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ù„ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§ØªÙ‡Ù….");
    }
  };


  return (
    <div className="space-y-8">
      <h2 className="text-3xl font-semibold text-gray-700 mb-6">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„Ø©</h2>

      {/* Financial Overview Section */}
      <div className="bg-white p-6 rounded-lg shadow-md">
        <h3 className="text-2xl font-semibold text-gray-800 mb-4">Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ù…Ø§Ù„ÙŠØ©</h3>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
          <div className="p-4 bg-blue-50 rounded-lg">
            <p className="text-lg text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</p>
            <p className="text-3xl font-bold text-blue-800">{totalRevenue.toLocaleString()} Ø¯.Ù„</p>
          </div>
          <div className="p-4 bg-red-50 rounded-lg">
            <p className="text-lg text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</p>
            <p className="text-3xl font-bold text-red-800">{totalExpenses.toLocaleString()} Ø¯.Ù„</p>
          </div>
          <div className="p-4 bg-green-50 rounded-lg">
            <p className="text-lg text-gray-600">ØµØ§ÙÙŠ Ø§Ù„Ø¯Ø®Ù„</p>
            <p className={`text-3xl font-bold ${netIncome >= 0 ? 'text-green-800' : 'text-red-800'}`}>
              {netIncome.toLocaleString()} Ø¯.Ù„
            </p>
          </div>
        </div>
      </div>

      {/* Student Status Chart Section */}
      <div className="bg-white p-6 rounded-lg shadow-md">
        <h3 className="text-2xl font-semibold text-gray-800 mb-4">Ø­Ø§Ù„Ø© Ø¯ÙØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
        {students.length === 0 ? (
          <p className="text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø·Ù„Ø§Ø¨ Ù„Ø¹Ø±Ø¶Ù‡Ø§.</p>
        ) : (
          <ResponsiveContainer width="100%" height={300}>
            <PieChart>
              <Pie
                data={studentStatusData}
                cx="50%"
                cy="50%"
                labelLine={false}
                outerRadius={100}
                fill="#8884d8"
                dataKey="value"
                label={({ name, percent }) => `${name}: ${(percent * 100).toFixed(0)}%`}
              >
                {studentStatusData.map((entry, index) => (
                  <Cell key={`cell-${index}`} fill={entry.color} />
                ))}
              </Pie>
              <Tooltip />
              <Legend />
            </PieChart>
          </ResponsiveContainer>
        )}
      </div>

      {/* Class Enrollment Chart Section */}
      <div className="bg-white p-6 rounded-lg shadow-md">
        <h3 className="text-2xl font-semibold text-gray-800 mb-4">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ø§Ù„ÙØµÙˆÙ„</h3>
        {classEnrollmentData.length === 0 ? (
          <p className="text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙØµÙˆÙ„ Ù„Ø¹Ø±Ø¶Ù‡Ø§.</p>
        ) : (
          <ResponsiveContainer width="100%" height={300}>
            <BarChart
              data={classEnrollmentData}
              margin={{ top: 5, right: 30, left: 20, bottom: 5 }}
            >
              <CartesianGrid strokeDasharray="3 3" />
              <XAxis dataKey="name" />
              <YAxis />
              <Tooltip />
              <Legend />
              <Bar dataKey="students" fill="#8884d8" name="Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨" />
            </BarChart>
          </ResponsiveContainer>
        )}
      </div>

      {/* Export Students by Class Section */}
      <div className="bg-white p-6 rounded-lg shadow-md">
        <h3 className="text-2xl font-semibold text-gray-800 mb-4">ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ Ø­Ø³Ø¨ Ø§Ù„ÙØµÙ„</h3>
        {classes.length === 0 ? (
          <p className="text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØµÙˆÙ„ Ù„Ø¥Ø¯Ø§Ø±Ø© ØªØµØ¯ÙŠØ± Ø§Ù„Ø·Ù„Ø§Ø¨.</p>
        ) : (
          <>
            <div className="mb-4">
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Ø§Ø®ØªØ± Ø§Ù„ÙØµÙˆÙ„ Ù„ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø·Ù„Ø§Ø¨Ù‡Ø§:
              </label>
              <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2 max-h-40 overflow-y-auto border border-gray-300 p-3 rounded-md">
                {classes.map(cls => (
                  <div key={cls.id} className="flex items-center">
                    <input
                      type="checkbox"
                      id={`class-${cls.id}`}
                      value={cls.id}
                      checked={selectedClassIds.includes(cls.id)}
                      onChange={handleClassSelectionChange}
                      className="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                    />
                    <label htmlFor={`class-${cls.id}`} className="ml-2 text-sm text-gray-700">
                      {cls.name} ({cls.students ? cls.students.length : 0} Ø·Ù„Ø§Ø¨)
                    </label>
                  </div>
                ))}
              </div>
            </div>
            <button
              onClick={handleExportStudentsByClass}
              className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105"
            >
              ØªØµØ¯ÙŠØ± Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ø§Ù„ÙØµÙˆÙ„ Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© (CSV)
            </button>
          </>
        )}
      </div>

      {/* Expenses by Category Chart Section */}
      <div className="bg-white p-6 rounded-lg shadow-md">
        <h3 className="text-2xl font-semibold text-gray-800 mb-4">Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©</h3>
        {expensesByCategoryData.length === 0 ? (
          <p className="text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØµØ§Ø±ÙŠÙ Ù„Ø¹Ø±Ø¶Ù‡Ø§.</p>
        ) : (
          <ResponsiveContainer width="100%" height={300}>
            <PieChart>
              <Pie
                data={expensesByCategoryData}
                cx="50%"
                cy="50%"
                labelLine={false}
                outerRadius={100}
                fill="#8884d8"
                dataKey="value"
                label={({ name, percent }) => `${name}: ${(percent * 100).toFixed(0)}%`}
              >
                {expensesByCategoryData.map((entry, index) => (
                  <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                ))}
              </Pie>
              <Tooltip formatter={(value) => `${value.toLocaleString()} Ø¯.Ù„`} />
              <Legend />
            </PieChart>
          </ResponsiveContainer>
        )}
      </div>

      {/* Revenue by Course Chart Section */}
      <div className="bg-white p-6 rounded-lg shadow-md">
        <h3 className="text-2xl font-semibold text-gray-800 mb-4">Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ±Ø©</h3>
        {revenueByCourseData.length === 0 ? (
          <p className="text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ù„Ù„Ø¯ÙˆØ±Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.</p>
        ) : (
          <ResponsiveContainer width="100%" height={300}>
            <BarChart
              data={revenueByCourseData}
              margin={{ top: 5, right: 30, left: 20, bottom: 5 }}
            >
              <CartesianGrid strokeDasharray="3 3" />
              <XAxis dataKey="name" />
              <YAxis formatter={(value) => `${value.toLocaleString()} Ø¯.Ù„`} />
              <Tooltip formatter={(value) => `${value.toLocaleString()} Ø¯.Ù„`} />
              <Legend />
              <Bar dataKey="value" fill="#00C49F" name="Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª" />
            </BarChart>
          </ResponsiveContainer>
        )}
      </div>

      {/* Future Reports Placeholder Section */}
      <div className="bg-white p-6 rounded-lg shadow-md text-center text-gray-500">
        <h3 className="text-2xl font-semibold text-gray-700 mb-4">ØªÙ‚Ø§Ø±ÙŠØ± Ø¥Ø¶Ø§ÙÙŠØ© Ù‚Ø±ÙŠØ¨Ø§Ù‹...</h3>
        <p>Ù…Ø«Ù„: ØªÙ‚Ø§Ø±ÙŠØ± Ø­Ø¶ÙˆØ± Ø§Ù„Ø·Ù„Ø§Ø¨ØŒ ØªÙ‚Ø§Ø±ÙŠØ± Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø¯Ø±Ø¨ÙŠÙ†ØŒ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©.</p>
      </div>
    </div>
  );
};


// AttendancePage component: Manages student attendance records.
const AttendancePage = ({ students, classes, instructors, addAttendance, attendances }) => {
  const [selectedClassId, setSelectedClassId] = useState('');
  const [selectedInstructorId, setSelectedInstructorId] = useState('');
  // Default date to today's date in YYYY-MM-DD format
  const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
  const [classStudents, setClassStudents] = useState([]); // Students belonging to the selected class
  const [attendanceStatuses, setAttendanceStatuses] = useState({}); // { studentId: status } for current selection

  // Effect to update classStudents and attendanceStatuses when class, students, date, or attendances change
  useEffect(() => {
    if (selectedClassId) {
      const currentClass = classes.find(cls => cls.id === selectedClassId);
      if (currentClass && currentClass.students) {
        // Filter students to only include those assigned to the selected class
        const studentsInClass = students.filter(s => currentClass.students.includes(s.id));
        setClassStudents(studentsInClass);

        // Load existing attendance for the selected class and date
        const existingAttendanceMap = {};
        attendances.forEach(att => {
          // Convert Firestore Timestamp to YYYY-MM-DD string for accurate comparison
          const attDate = att.date.toDate().toISOString().split('T')[0];
          if (att.classId === selectedClassId && attDate === selectedDate) {
            existingAttendanceMap[att.studentId] = att.status;
          }
        });
        setAttendanceStatuses(existingAttendanceMap);
      } else {
        // Reset if no class or students found
        setClassStudents([]);
        setAttendanceStatuses({});
      }
    } else {
      // Reset if no class is selected
      setClassStudents([]);
      setAttendanceStatuses({});
    }
  }, [selectedClassId, students, classes, selectedDate, attendances]); // Dependencies for this effect

  // Handler for updating a student's attendance status
  const handleAttendanceChange = (studentId, status) => {
    setAttendanceStatuses(prev => ({
      ...prev,
      [studentId]: status
    }));
  };

  // Handler for submitting attendance records
  const handleSubmitAttendance = async () => {
    if (!selectedClassId || !selectedInstructorId || !selectedDate) {
      alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØµÙ„ØŒ Ø§Ù„Ù…Ø¯Ø±Ø¨ØŒ ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® Ø£ÙˆÙ„Ø§Ù‹.");
      return;
    }

    if (Object.keys(attendanceStatuses).length === 0) {
      alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± Ø§Ù„Ø·Ù„Ø§Ø¨ Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸.");
      return;
    }

    const attendanceRecordsToSave = [];
    for (const studentId in attendanceStatuses) {
      attendanceRecordsToSave.push({
        studentId,
        classId: selectedClassId,
        instructorId: selectedInstructorId,
        date: new Date(selectedDate), // Ensure date is a Date object
        status: attendanceStatuses[studentId],
      });
    }

    try {
      // Use Promise.all to concurrently add/update all attendance records
      // The `addAttendance` function uses `setDoc` with `merge: true` to handle upsert logic
      await Promise.all(attendanceRecordsToSave.map(record => addAttendance(record)));

      alert("ØªÙ… Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­!");
      // Optionally, you might want to reset the form or provide further feedback
      // For example, clear selectedClassId and selectedInstructorId to start fresh
      // setSelectedClassId('');
      // setSelectedInstructorId('');
      // setAttendanceStatuses({});
    } catch (error) {
      console.error("Error saving attendance:", error);
      alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ±.");
    }
  };

  // Helper function to get instructor name (though not used in rendering table, useful for debugging/future)
  const getInstructorName = (id) => {
    const instructor = instructors.find(inst => inst.id === id);
    return instructor ? instructor.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
  };

  // Helper function to get instructors assigned to the selected class
  const getClassInstructors = (classId) => {
    const cls = classes.find(c => c.id === classId);
    if (!cls || !cls.instructors) return [];
    return instructors.filter(inst => cls.instructors.includes(inst.id));
  };


  return (
    <div className="space-y-6">
      <h2 className="text-2xl font-semibold text-gray-700">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨</h2>

      <div className="bg-white p-6 rounded-lg shadow-md flex flex-wrap gap-4 items-end">
        <div className="flex-1 min-w-[200px]">
          <label htmlFor="classSelect" className="block text-sm font-medium text-gray-700 mb-1">
            Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„:
          </label>
          <select
            id="classSelect"
            value={selectedClassId}
            onChange={(e) => {
              setSelectedClassId(e.target.value);
              setSelectedInstructorId(''); // Reset instructor when class changes
            }}
            className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
          >
            <option value="">Ø§Ø®ØªØ± ÙØµÙ„...</option>
            {classes.map(cls => (
              <option key={cls.id} value={cls.id}>{cls.name}</option>
            ))}
          </select>
        </div>

        <div className="flex-1 min-w-[200px]">
          <label htmlFor="instructorSelect" className="block text-sm font-medium text-gray-700 mb-1">
            Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯Ø±Ø¨:
          </label>
          <select
            id="instructorSelect"
            value={selectedInstructorId}
            onChange={(e) => setSelectedInstructorId(e.target.value)}
            className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
            // Disable instructor selection if no class is chosen or no instructors are assigned to the class
            disabled={!selectedClassId || getClassInstructors(selectedClassId).length === 0}
          >
            <option value="">Ø§Ø®ØªØ± Ù…Ø¯Ø±Ø¨Ø§Ù‹...</option>
            {selectedClassId && getClassInstructors(selectedClassId).map(inst => (
              <option key={inst.id} value={inst.id}>{inst.name}</option>
            ))}
          </select>
          {selectedClassId && getClassInstructors(selectedClassId).length === 0 && (
            <p className="text-red-500 text-xs mt-1">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¯Ø±Ø¨ÙˆÙ† Ù…Ù†Ø³ÙˆØ¨ÙˆÙ† Ù„Ù‡Ø°Ø§ Ø§Ù„ÙØµÙ„.</p>
          )}
        </div>

        <div className="flex-1 min-w-[200px]">
          <label htmlFor="attendanceDate" className="block text-sm font-medium text-gray-700 mb-1">
            Ø§Ù„ØªØ§Ø±ÙŠØ®:
          </label>
          <input
            type="date"
            id="attendanceDate"
            value={selectedDate}
            onChange={(e) => setSelectedDate(e.target.value)}
            className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
          />
        </div>
      </div>

      {/* Display student attendance table if class and instructor are selected and students exist */}
      {selectedClassId && selectedInstructorId && classStudents.length > 0 && (
        <div className="bg-white rounded-lg shadow-md overflow-hidden mt-6">
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨
                </th>
                <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Ø§Ù„Ø­Ø§Ù„Ø©
                </th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {classStudents.map(student => (
                <tr key={student.id}>
                  <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                    {student.name}
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    <div className="flex items-center space-x-4">
                      {/* Radio buttons for attendance status */}
                      <label className="inline-flex items-center">
                        <input
                          type="radio"
                          name={`attendance-${student.id}`} // Unique name for each student's radio group
                          value="present"
                          checked={attendanceStatuses[student.id] === 'present'}
                          onChange={() => handleAttendanceChange(student.id, 'present')}
                          className="form-radio text-green-600 h-4 w-4"
                        />
                        <span className="ml-2 text-green-700">Ø­Ø§Ø¶Ø±</span>
                      </label>
                      <label className="inline-flex items-center">
                        <input
                          type="radio"
                          name={`attendance-${student.id}`}
                          value="absent"
                          checked={attendanceStatuses[student.id] === 'absent'}
                          onChange={() => handleAttendanceChange(student.id, 'absent')}
                          className="form-radio text-red-600 h-4 w-4"
                        />
                        <span className="ml-2 text-red-700">ØºØ§Ø¦Ø¨</span>
                      </label>
                      <label className="inline-flex items-center">
                        <input
                          type="radio"
                          name={`attendance-${student.id}`}
                          value="late"
                          checked={attendanceStatuses[student.id] === 'late'}
                          onChange={() => handleAttendanceChange(student.id, 'late')}
                          className="form-radio text-yellow-600 h-4 w-4"
                        />
                        <span className="ml-2 text-yellow-700">Ù…ØªØ£Ø®Ø±</span>
                      </label>
                      <label className="inline-flex items-center">
                        <input
                          type="radio"
                          name={`attendance-${student.id}`}
                          value="excused"
                          checked={attendanceStatuses[student.id] === 'excused'}
                          onChange={() => handleAttendanceChange(student.id, 'excused')}
                          className="form-radio text-gray-600 h-4 w-4"
                        />
                        <span className="ml-2 text-gray-700">Ø¨Ø¹Ø°Ø±</span>
                      </label>
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
          <div className="p-4 bg-gray-50 flex justify-end">
            <button
              onClick={handleSubmitAttendance}
              className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105"
            >
              Ø­ÙØ¸ Ø§Ù„Ø­Ø¶ÙˆØ±
            </button>
          </div>
        </div>
      )}

      {/* Messages for user guidance */}
      {selectedClassId && selectedInstructorId && classStudents.length === 0 && (
        <div className="text-center text-gray-500 p-6 bg-white rounded-lg shadow-md">
          <p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù…Ù†Ø³ÙˆØ¨ÙˆÙ† Ù„Ù‡Ø°Ø§ Ø§Ù„ÙØµÙ„.</p>
        </div>
      )}

      {!selectedClassId || !selectedInstructorId ? (
        <div className="text-center text-gray-500 p-6 bg-white rounded-lg shadow-md">
          <p>Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± **Ø§Ù„ÙØµÙ„** Ùˆ**Ø§Ù„Ù…Ø¯Ø±Ø¨** Ù„Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±.</p>
        </div>
      ) : null}

    </div>
  );
};


// PlaceholderPage component: A generic component for pages that are not yet implemented.
const PlaceholderPage = ({ title }) => (
  <div className="text-center text-gray-600 text-2xl p-10">
    ØµÙØ­Ø© {title} (Ù‚Ø±ÙŠØ¨Ø§Ù‹...)
  </div>
);

// ==================================================================================================
// --- MAIN APP COMPONENT ---
// ==================================================================================================

const App = () => {
  // State variables for active section, user details, and all data collections
  const [activeSection, setActiveSection] = useState('dashboard');
  const [userId, setUserId] = useState(null);
  const [userRole, setUserRole] = useState('admin'); // User role state: 'admin' or 'supervisor'
  const [students, setStudents] = useState([]);
  const [classes, setClasses] = useState([]);
  const [expenses, setExpenses] = useState([]);
  const [courses, setCourses] = useState([]);
  const [instructors, setInstructors] = useState([]);
  const [payments, setPayments] = useState([]);
  const [attendances, setAttendances] = useState([]); // State for attendance records
  const [db, setDb] = useState(null); // Firestore instance
  const [auth, setAuth] = useState(null); // Firebase Auth instance
  const [isAuthReady, setIsAuthReady] = useState(false); // Flag to indicate Firebase auth is ready

  // useEffect for Firebase initialization and authentication state listener
  useEffect(() => {
    try {
      // Retrieve Firebase config and app ID from global variables (provided by Canvas environment)
      const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
      const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

      // Initialize Firebase app, Firestore, and Auth
      const app = initializeApp(firebaseConfig);
      const firestore = getFirestore(app);
      const firebaseAuth = getAuth(app);

      setDb(firestore);
      setAuth(firebaseAuth);

      // Async function to sign in and set up auth state listener
      const signInAndListen = async () => {
        if (typeof __initial_auth_token !== 'undefined') {
          // Sign in with custom token if provided (for authenticated sessions)
          await signInWithCustomToken(firebaseAuth, __initial_auth_token);
        } else {
          // Sign in anonymously if no custom token (for basic access)
          await signInAnonymously(firebaseAuth);
        }

        // Set up auth state change listener
        const unsubscribeAuth = onAuthStateChanged(firebaseAuth, (user) => {
          if (user) {
            setUserId(user.uid);
            // In a real application, user roles would be fetched from a dedicated 'users' collection
            // For this simulation, the role is managed by the `userRole` state and its switcher.
          } else {
            setUserId(crypto.randomUUID()); // Assign a random ID for anonymous users
            setUserRole('admin'); // Default anonymous users to 'admin' role for full access by default
          }
          setIsAuthReady(true); // Mark auth as ready
        });
        return unsubscribeAuth; // Return unsubscribe function
      };

      let unsubscribeAuthPromise = signInAndListen(); // Call the async sign-in function

      // Cleanup function for useEffect: unsubscribe from auth listener
      return () => {
        unsubscribeAuthPromise.then(unsubscribe => {
          if (unsubscribe) {
            unsubscribe();
          }
        });
      };
    } catch (error) {
      console.error("Error initializing Firebase:", error);
    }
  }, []); // Empty dependency array means this effect runs once on mount

  // Generic useEffect hook for fetching data from Firestore collections
  // This pattern is repeated for students, classes, expenses, courses, instructors, payments, and attendances.
  const setupCollectionListener = (collectionName, setStateFunction) => {
    useEffect(() => {
      if (db && isAuthReady) {
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const collectionRef = collection(db, `artifacts/${appId}/public/data/${collectionName}`);
        const unsubscribe = onSnapshot(collectionRef, (snapshot) => {
          const data = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
          }));
          setStateFunction(data);
        }, (error) => {
          console.error(`Error fetching ${collectionName}:`, error);
        });
        return () => unsubscribe(); // Cleanup listener on unmount or dependency change
      }
    }, [db, isAuthReady, collectionName, setStateFunction]); // Dependencies for this effect
  };

  // Call the generic listener setup for each collection
  setupCollectionListener('students', setStudents);
  setupCollectionListener('classes', setClasses);
  setupCollectionListener('expenses', setExpenses);
  setupCollectionListener('courses', setCourses);
  setupCollectionListener('instructors', setInstructors);
  setupCollectionListener('payments', setPayments);
  setupCollectionListener('attendance', setAttendances); // New listener for attendance data


  // Firestore operations for Students
  const addStudent = async (newStudent) => {
    if (!db) { console.error("Firestore DB not initialized."); return; }
    try {
      const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
      const studentsCollectionRef = collection(db, `artifacts/${appId}/public/data/students`);
      await addDoc(studentsCollectionRef, { ...newStudent, createdAt: Timestamp.now() }); // Use Timestamp for createdAt
      console.log("Student added successfully!");
    } catch (e) { console.error("Error adding document: ", e); }
  };

  const updateStudent = async (studentId, updatedData) => {
    if (!db) { console.error("Firestore DB not initialized."); return; }
    try {
      const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
      const studentDocRef = doc(db, `artifacts/${appId}/public/data/students`, studentId);
      await updateDoc(studentDocRef, updatedData);
      console.log("Student updated successfully!");
    } catch (e) { console.error("Error updating document: ", e); }
  };

  const deleteStudent = async (studentId) => {
    if (!db) { console.error("Firestore DB not initialized."); return; }
    try {
      const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
      const studentDocRef = doc(db, `artifacts/${appId}/public/data/students`, studentId);
      await deleteDoc(studentDocRef);
      console.log("Student deleted successfully!");
    } catch (e) { console.error("Error deleting document: ", e); }
  };

  // Firestore operations for Classes
  const addClass = async (newClass) => {
    if (!db) { console.error("Firestore DB not initialized."); return; }
    try {
      const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
      const classesCollectionRef = collection(db, `artifacts/${appId}/public/data/classes`);
      await addDoc(classesCollectionRef, { ...newClass, students: [], instructors: [], createdAt: Timestamp.now() });
      console.log("Class added successfully!");
    } catch (e) { console.error("Error adding class: ", e); }
  };

  const updateClass = async (classId, updatedData) => {
    if (!db) { console.error("Firestore DB not initialized."); return; }
    try {
      const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
      const classDocRef = doc(db, `artifacts/${appId}/public/data/classes`, classId);
      await updateDoc(classDocRef, updatedData);
      console.log("Class updated successfully!");
    } catch (e) { console.error("Error updating class: ", e); }
  };

  const deleteClass = async (classId) => {
    if (!db) { console.error("Firestore DB not initialized."); return; }
    try {
      const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
      const classDocRef = doc(db, `artifacts/${appId}/public/data/classes`, classId);
      await deleteDoc(classDocRef);
      console.log("Class deleted successfully!");
    } catch (e) { console.error("Error deleting class: ", e); }
  };

  // Firestore operations for Expenses
  const addExpense = async (newExpense) => {
    if (!db) { console.error("Firestore DB not initialized."); return; }
    try {
      const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
      const expensesCollectionRef = collection(db, `artifacts/${appId}/public/data/expenses`);
      // Convert date to Firestore Timestamp before saving
      await addDoc(expensesCollectionRef, { ...newExpense, date: Timestamp.fromDate(newExpense.date), createdAt: Timestamp.now() });
      console.log("Expense added successfully!");
    } catch (e) { console.error("Error adding expense: ", e); }
  };

  const updateExpense = async (expenseId, updatedData) => {
    if (!db) { console.error("Firestore DB not initialized."); return; }
    try {
      const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
      const expenseDocRef = doc(db, `artifacts/${appId}/public/data/expenses`, expenseId);
      // Convert date to Firestore Timestamp before saving
      await updateDoc(expenseDocRef, { ...updatedData, date: Timestamp.fromDate(updatedData.date) });
      console.log("Expense updated successfully!");
    } catch (e) { console.error("Error updating expense: ", e); }
  };

  const deleteExpense = async (expenseId) => {
    if (!db) { console.error("Firestore DB not initialized."); return; }
    try {
      const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
      const expenseDocRef = doc(db, `artifacts/${appId}/public/data/expenses`, expenseId);
      await deleteDoc(expenseDocRef);
      console.log("Expense deleted successfully!");
    } catch (e) { console.error("Error deleting expense: ", e); }
  };

  // Firestore operations for Courses
  const addCourse = async (newCourse) => {
    if (!db) { console.error("Firestore DB not initialized."); return; }
    try {
      const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
      const coursesCollectionRef = collection(db, `artifacts/${appId}/public/data/courses`);
      await addDoc(coursesCollectionRef, { ...newCourse, createdAt: Timestamp.now() });
      console.log("Course added successfully!");
    } catch (e) { console.error("Error adding course: ", e); }
  };

  const updateCourse = async (courseId, updatedData) => {
    if (!db) { console.error("Firestore DB not initialized."); return; }
    try {
      const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
      const courseDocRef = doc(db, `artifacts/${appId}/public/data/courses`, courseId);
      await updateDoc(courseDocRef, updatedData);
      console.log("Course updated successfully!");
  
