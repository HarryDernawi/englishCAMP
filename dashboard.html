<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¹Ù„Ø§Ù† Ù…Ø®ÙŠÙ… Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© - Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯ÙŠØ±</title>
    <!-- Visualization & Content Choices:
        - Admin - Settings: HTML forms (text, color, textarea). Goal: Customization. Interaction: Admin input.
        - Admin - Live Preview: iframe with postMessage updates. Goal: Feedback. Interaction: Real-time update.
        - Admin - Student Management: HTML list/cards with buttons/selects. Goal: Management. Interaction: Admin actions (mark, label, delete).
        - NO SVG/Mermaid used. Chart.js/Plotly.js not applicable for this report type.
    -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --body-bg: #E6F0F5;
            --header-gradient-start: #3F72AF;
            --header-gradient-end: #112D4E;
            --feature-icon-color: #3B82F6;
            --form-submit-button-start: #3B82F6;
            --form-submit-button-end: #2563EB;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--body-bg);
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            min-height: 100vh;
            padding: 10px; /* Reduced padding for smaller side margins */
        }
        .navbar {
            background-color: var(--header-gradient-end);
            width: 100%;
            max-width: 900px; /* Increased max-width for smaller side margins */
            border-radius: 1.5rem 1.5rem 0 0;
            padding: 1rem;
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 50;
        }
        .nav-button {
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s ease, transform 0.2s ease;
            text-decoration: none;
        }
        .nav-button:hover {
            background-color: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }
        .nav-button.active {
            background-color: var(--header-gradient-start);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .page-container {
            background-color: #ffffff;
            border-radius: 0 0 1.5rem 1.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            max-width: 900px; /* Increased max-width for smaller side margins */
            width: 100%;
            overflow: hidden;
            text-align: center;
            padding: 1.5rem 2rem 2.5rem; /* Reduced top padding */
        }
        .admin-dashboard-wrapper {
            display: flex;
            flex-direction: column; /* Stack vertically for small screens */
            gap: 20px; /* Gap between stacked elements for small screens */
            width: 100%;
            max-width: 100%;
        }
        @media (min-width: 1024px) {
            .admin-dashboard-wrapper {
                flex-direction: row-reverse; /* Preview on left, controls on right */
                justify-content: center; /* Center the two columns */
                gap: 0; /* Remove gap for desktop to make them touch */
            }
        }
        .admin-dashboard-section {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 1rem;
            flex: 1;
            width: 100%; /* Full width when stacked */
            padding: 2rem;
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            text-align: right;
            border-radius: 1rem; /* Default rounded corners for small screens */
        }
        @media (min-width: 1024px) {
            .admin-dashboard-section {
                width: 50%; /* 50% width on large screens */
                max-width: 50%; /* Ensure it doesn't exceed 50% */
                border-radius: 0 1rem 1rem 0; /* Rounded corners only on the right side */
                border-right: 1px solid #e2e8f0; /* Re-add right border */
                border-left: none; /* Remove left border to merge with preview */
            }
        }
        .admin-dashboard-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            width: 100%;
            margin-top: 1rem;
        }
        .admin-dashboard-actions button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
        }
        .admin-dashboard-actions button:hover {
            transform: translateY(-2px);
        }
        .save-button {
            background-color: #22c55e;
            color: white;
        }
        .apply-button {
            background-color: #f59e0b;
            color: white;
        }
        .preview-screen-container {
            display: block;
            flex: 1;
            width: 100%; /* Full width when stacked */
            position: relative;
            padding-top: 56.25%; /* 16:9 aspect ratio */
            height: 0;

            /* Computer screen styling */
            background-color: #1a202c; /* Darker bezel color */
            border: 15px solid #2d3748; /* Thicker, darker bezel */
            border-radius: 2rem; /* More rounded overall monitor */
            box-shadow: 0 0 0 5px #4a5568, 0 0 0 10px #718096, 0 25px 50px rgba(0,0,0,0.7); /* More pronounced shadows */
            margin-top: 20px; /* Space from the control panel above for small screens */
            display: flex; /* To center the iframe */
            justify-content: center;
            align-items: center;
        }
        .preview-screen-container::before { /* Monitor stand */
            content: '';
            position: absolute;
            bottom: -50px; /* Adjust position */
            left: 50%;
            transform: translateX(-50%);
            width: 100px; /* Wider stand */
            height: 30px; /* Taller stand */
            background-color: #2d3748;
            border-radius: 0 0 15px 15px; /* More rounded stand base */
            box-shadow: 0 10px 20px rgba(0,0,0,0.4);
            z-index: -1; /* Behind the monitor */
        }
        .preview-screen-container::after { /* Monitor base */
            content: '';
            position: absolute;
            bottom: -65px; /* Position below the stand */
            left: 50%;
            transform: translateX(-50%);
            width: 200px; /* Wider base */
            height: 15px; /* Thicker base */
            background-color: #4a5568;
            border-radius: 8px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.4);
            z-index: -2; /* Behind the stand */
        }
        .preview-screen-container .power-indicator {
            position: absolute;
            bottom: 20px; /* Position it on the bezel */
            right: 20px;
            width: 8px;
            height: 8px;
            background-color: #22c55e; /* Green for power on */
            border-radius: 50%;
            box-shadow: 0 0 5px #22c55e;
            z-index: 1;
        }
        .preview-screen-container iframe {
            position: absolute;
            top: 50%; /* Center vertically */
            left: 50%; /* Center horizontally */
            transform: translate(-50%, -50%); /* Adjust for centering */
            width: calc(100% - 30px); /* Account for bezel thickness */
            height: calc(100% - 30px); /* Account for bezel thickness */
            border: none;
            border-radius: 0.75rem; /* Slightly rounded corners for the screen itself */
            background-color: white; /* Ensure iframe background is white */
        }
        .preview-screen-container h4 {
            position: absolute;
            top: 15px; /* Adjusted position */
            width: 100%;
            text-align: center;
            font-weight: bold;
            color: #a0aec0; /* Lighter color for text on dark bezel */
            z-index: 1;
            padding: 0 10px;
            box-sizing: border-box;
            font-size: 1.1rem; /* Slightly larger heading */
        }
        @media (min-width: 1024px) {
            .preview-screen-container {
                margin-top: 0; /* No top margin when side-by-side */
                width: 50%; /* 50% width on large screens */
                max-width: 50%; /* Ensure it doesn't exceed 50% */
                border-radius: 1rem 0 0 1rem; /* Rounded corners only on the left side */
                border-left: 1px solid #2d3748; /* Re-add left border for the monitor */
                border-right: none; /* Remove right border to merge with control panel */
            }
        }

        .form-group {
            margin-bottom: 1.25rem;
            text-align: right;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #334155;
            font-size: 1rem;
        }
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="tel"],
        .form-group select,
        .form-group input[type="color"],
        .form-group textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #cbd5e0;
            border-radius: 0.5rem;
            font-size: 1rem;
            color: #334155;
            background-color: #ffffff;
        }
        .form-group input[type="color"] {
            height: 40px;
            padding: 0.25rem;
        }
        .registered-students-list {
            margin-top: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .student-card {
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            text-align: right;
            position: relative;
        }
        .student-card.contacted {
            border-left: 5px solid #10b981;
        }
        .student-card h4 {
            font-weight: 700;
            font-size: 1.25rem;
            color: #1a202c;
        }
        .student-card p {
            font-size: 0.95rem;
            color: #4a5568;
        }
        .student-card .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
            justify-content: flex-end;
        }
        .student-card .actions button, .student-card .actions select {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .student-card .actions .toggle-contacted {
            background-color: #3B82F6;
            color: white;
        }
        .student-card .actions .toggle-contacted.contacted {
            background-color: #10b981;
        }
        .student-card .actions .toggle-contacted:hover {
            background-color: #2563EB;
        }
        .student-card .actions .delete-btn {
            background-color: #ef4444;
            color: white;
        }
        .student-card .actions .delete-btn:hover {
            background-color: #dc2626;
        }
        .student-card .actions .label-select {
            background-color: #e2e8f0;
            border: 1px solid #cbd5e0;
            color: #334155;
        }
        .student-card .label-display {
            background-color: #bfdbfe;
            color: #1e40af;
            padding: 0.25rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.8rem;
            font-weight: 600;
            margin-top: 0.5rem;
            display: inline-block;
            align-self: flex-end;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
            position: relative;
        }
        .close-button {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <a href="index.html" class="nav-button">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        <a href="register.html" class="nav-button">Ø§Ù„ØªØ³Ø¬ÙŠÙ„</a>
        <a href="contact.html" class="nav-button">ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§</a>
        <a href="dashboard.html" class="nav-button active">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
    </div>

    <div class="page-container">
        <div id="adminDashboardWrapper" class="admin-dashboard-wrapper">
            <div id="adminDashboard" class="admin-dashboard-section">
                <h3 class="text-2xl font-bold text-gray-800 mb-4">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯ÙŠØ±</h3>
                <div class="form-group">
                    <label for="logoUrlInput">Ø±Ø§Ø¨Ø· Ø§Ù„Ø´Ø¹Ø§Ø± (URL):</label>
                    <input type="text" id="logoUrlInput" class="w-full" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„Ø´Ø¹Ø§Ø± Ù‡Ù†Ø§">
                </div>
                <div class="form-group">
                    <label for="bodyBgColorInput">Ù„ÙˆÙ† Ø®Ù„ÙÙŠØ© Ø§Ù„ØµÙØ­Ø©:</label>
                    <input type="color" id="bodyBgColorInput" class="w-full">
                </div>
                <div class="form-group">
                    <label for="headerGradientStartInput">Ù„ÙˆÙ† Ø¨Ø¯Ø§ÙŠØ© ØªØ¯Ø±Ø¬ Ø§Ù„Ù‡ÙŠØ¯Ø±:</label>
                    <input type="color" id="headerGradientStartInput" class="w-full">
                </div>
                <div class="form-group">
                    <label for="headerGradientEndInput">Ù„ÙˆÙ† Ù†Ù‡Ø§ÙŠØ© ØªØ¯Ø±Ø¬ Ø§Ù„Ù‡ÙŠØ¯Ø±:</label>
                    <input type="color" id="headerGradientEndInput" class="w-full">
                </div>
                <div class="form-group">
                    <label for="featureIconColorInput">Ù„ÙˆÙ† Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„Ù…ÙŠØ²Ø§Øª:</label>
                    <input type="color" id="featureIconColorInput" class="w-full">
                </div>
                <div class="form-group">
                    <label for="formSubmitButtonStartInput">Ù„ÙˆÙ† Ø¨Ø¯Ø§ÙŠØ© Ø²Ø± Ø§Ù„ØªØ³Ø¬ÙŠÙ„:</label>
                    <input type="color" id="formSubmitButtonStartInput" class="w-full">
                </div>
                <div class="form-group">
                    <label for="formSubmitButtonEndInput">Ù„ÙˆÙ† Ù†Ù‡Ø§ÙŠØ© Ø²Ø± Ø§Ù„ØªØ³Ø¬ÙŠÙ„:</label>
                    <input type="color" id="formSubmitButtonEndInput" class="w-full">
                </div>
                <div class="form-group">
                    <label for="mainTitleInput">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ:</label>
                    <input type="text" id="mainTitleInput" class="w-full">
                </div>
                <div class="form-group">
                    <label for="campSloganInput">Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø®ÙŠÙ… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ:</label>
                    <textarea id="campSloganInput" class="w-full h-20"></textarea>
                </div>
                <div class="form-group">
                    <label for="campNameInput">Ø§Ø³Ù… Ø§Ù„Ù…Ø®ÙŠÙ…:</label>
                    <input type="text" id="campNameInput" class="w-full">
                </div>
                <div class="form-group">
                    <label for="registrationStatusInput">Ø­Ø§Ù„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„:</label>
                    <input type="text" id="registrationStatusInput" class="w-full">
                </div>
                <div class="form-group">
                    <label for="programIntroInput">Ù…Ù‚Ø¯Ù…Ø© Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬:</label>
                    <textarea id="programIntroInput" class="w-full h-20"></textarea>
                </div>
                <div class="form-group">
                    <label for="programHeadingInput">Ø¹Ù†ÙˆØ§Ù† Ù‚Ø³Ù… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬:</label>
                    <input type="text" id="programHeadingInput" class="w-full">
                </div>
                <div class="form-group">
                    <label for="educationalHoursHeadingInput">Ø¹Ù†ÙˆØ§Ù† Ø³Ø§Ø¹Ø§Øª Ø§Ù„ØªØ¹Ù„ÙŠÙ…:</label>
                    <input type="text" id="educationalHoursHeadingInput" class="w-full">
                </div>
                <div class="form-group">
                    <label for="recreationalHoursHeadingInput">Ø¹Ù†ÙˆØ§Ù† Ø³Ø§Ø¹Ø§Øª Ø§Ù„ØªØ±ÙÙŠÙ‡:</label>
                    <input type="text" id="recreationalHoursHeadingInput" class="w-full">
                </div>
                <div class="form-group">
                    <label for="methodologyHeadingInput">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù†Ù‡Ø¬ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</label>
                    <input type="text" id="methodologyHeadingInput" class="w-full">
                </div>
                <div class="form-group">
                    <label for="methodologyDescriptionInput">ÙˆØµÙ Ø§Ù„Ù…Ù†Ù‡Ø¬:</label>
                    <textarea id="methodologyDescriptionInput" class="w-full h-20"></textarea>
                </div>
                <div class="form-group">
                    <label for="durationTextInput">Ù†Øµ Ø§Ù„Ù…Ø¯Ø©:</label>
                    <input type="text" id="durationTextInput" class="w-full">
                </div>
                <div class="form-group">
                    <label for="datesTextInput">Ù†Øµ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®:</label>
                    <input type="text" id="datesTextInput" class="w-full">
                </div>
                <div class="form-group">
                    <label for="locationTextInput">Ù†Øµ Ø§Ù„Ù…ÙˆÙ‚Ø¹:</label>
                    <input type="text" id="locationTextInput" class="w-full">
                </div>
                <div class="form-group">
                    <label for="contactPhoneDisplayInput">Ù†Øµ Ø±Ù‚Ù… Ø§Ù„Ø§ØªØµØ§Ù„ (Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ):</label>
                    <input type="text" id="contactPhoneDisplayInput" class="w-full">
                </div>
                <div class="form-group">
                    <label for="ourGoalHeadingTextInput">Ø¹Ù†ÙˆØ§Ù† Ù‡Ø¯ÙÙ†Ø§:</label>
                    <input type="text" id="ourGoalHeadingTextInput" class="w-full">
                </div>
                <div class="form-group">
                    <label for="ourGoalDescriptionTextInput">ÙˆØµÙ Ù‡Ø¯ÙÙ†Ø§:</label>
                    <textarea id="ourGoalDescriptionTextInput" class="w-full h-20"></textarea>
                </div>
                <div class="form-group">
                    <label for="limitedSeatsTextInput">Ù†Øµ Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø¯ÙˆØ¯Ø©:</label>
                    <input type="text" id="limitedSeatsTextInput" class="w-full">
                </div>
                <div class="form-group">
                    <label for="bottomContactInfoTextInput">Ù†Øµ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ (Ø§Ù„Ø£Ø³ÙÙ„):</label>
                    <textarea id="bottomContactInfoTextInput" class="w-full h-20"></textarea>
                </div>
                <div class="form-group">
                    <label for="bottomPhoneTextInput">Ù†Øµ Ø§Ù„Ù‡Ø§ØªÙ (Ø§Ù„Ø£Ø³ÙÙ„):</label>
                    <input type="text" id="bottomPhoneTextInput" class="w-full">
                </div>
                <div class="form-group">
                    <label for="hashtagsTextInput">Ù†Øµ Ø§Ù„Ù‡Ø§Ø´ØªØ§Ø¬Ø§Øª:</label>
                    <textarea id="hashtagsTextInput" class="w-full h-20"></textarea>
                </div>
                <h4 class="text-lg font-bold text-gray-700 mt-4 mb-2">Ø¬Ù…Ù„ Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø±:</h4>
                <div class="form-group">
                    <label for="sliderPhrase1Input">Ø§Ù„Ø¬Ù…Ù„Ø© 1:</label>
                    <input type="text" id="sliderPhrase1Input" class="w-full">
                </div>
                <div class="form-group">
                    <label for="sliderPhrase2Input">Ø§Ù„Ø¬Ù…Ù„Ø© 2:</label>
                    <input type="text" id="sliderPhrase2Input" class="w-full">
                </div>
                <div class="form-group">
                    <label for="sliderPhrase3Input">Ø§Ù„Ø¬Ù…Ù„Ø© 3:</label>
                    <input type="text" id="sliderPhrase3Input" class="w-full">
                </div>
                <div class="form-group">
                    <label for="sliderPhrase4Input">Ø§Ù„Ø¬Ù…Ù„Ø© 4:</label>
                    <input type="text" id="sliderPhrase4Input" class="w-full">
                </div>
                <div class="form-group">
                    <label for="sliderPhrase5Input">Ø§Ù„Ø¬Ù…Ù„Ø© 5:</label>
                    <input type="text" id="sliderPhrase5Input" class="w-full">
                </div>

                <div class="admin-dashboard-actions">
                    <button id="applySettingsBtn" class="apply-button">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
                    <button id="saveSettingsBtn" class="save-button">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
                </div>

                <div class="registered-students-section mt-8">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†</h3>
                    <div id="registeredStudentsAdminList" class="registered-students-list">
                        <p class="text-gray-500">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†...</p>
                    </div>
                </div>
            </div>

            <div id="previewScreenContainer" class="preview-screen-container">
                <h4>Ù…Ø¹Ø§ÙŠÙ†Ø© Ø­ÙŠØ©</h4>
                <div class="power-indicator"></div>
                <iframe id="previewIframe" srcdoc="" title="Live Preview"></iframe>
            </div>
        </div>
    </div>

    <div id="myModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <p id="modalMessage" class="text-lg font-semibold text-gray-800"></p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUserId = null;

        const defaultSettings = {
            logoUrl: '487167779_29373139318966172_855389515226951087_n-removebg-preview.png',
            colors: {
                bodyBg: '#E6F0F5',
                headerGradientStart: '#3F72AF',
                headerGradientEnd: '#112D4E',
                featureIconColor: '#3B82F6',
                formSubmitButtonStart: '#3B82F6',
                formSubmitButtonEnd: '#2563EB'
            },
            texts: {
                mainTitle: "Ø§Ù„Ù€ English Ù…Ø´ Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† Ø¹Ù‚Ø¯Ø© ! ğŸ¯",
                campSlogan: "ØªØ®ÙŠÙ‘Ù„ ØµÙŠÙ ÙŠÙƒÙˆÙ† ÙÙŠÙ‡ ØªØ¹Ù„Ù‘Ù… Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ù‡Ùˆ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ù…Ù…ØªØ¹ Ù…Ù† ÙŠÙˆÙ… Ø·ÙÙ„Ùƒ!",
                campName: "Ù…Ø®ÙŠÙ… Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©",
                registrationStatus: "Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ© - ØªØ³Ø¬ÙŠÙ„ Ù…ÙØªÙˆØ­ Ø§Ù„Ø¢Ù†!",
                programIntro: "Ø¨Ø¯Ù„ Ù…Ø§ ÙŠÙ‚Ø¶ÙŠ Ø§Ù„ØµÙŠÙ Ù‚Ø¯Ø§Ù… Ø§Ù„Ø´Ø§Ø´Ø§ØªØŒ ÙŠØ¬Ù…Ø¹ Ù…Ø®ÙŠÙ…Ù†Ø§ Ø¨ÙŠÙ† Ø§Ù„Ù„ØºØ©ØŒ Ø§Ù„Ø«Ù‚Ø©ØŒ ÙˆØ§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ù‡Ø§Ø¯Ù ÙÙŠ ØªØ¬Ø±Ø¨Ø© ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ù„Ø§ ØªÙÙ†Ø³Ù‰.",
                programHeading: "Ø¨Ø±Ù†Ø§Ù…Ø¬ ÙŠÙˆÙ…ÙŠ Ù…ØªÙˆØ§Ø²Ù† ÙˆÙ…ØµÙ…Ù‘Ù… Ø¨Ø¹Ù†Ø§ÙŠØ©:",
                educationalHoursHeading: "ğŸ§  3 Ø³Ø§Ø¹Ø§Øª ØªØ¹Ù„ÙŠÙ…ÙŠØ© ÙØ¹Ù‘Ø§Ù„Ø©:",
                recreationalHoursHeading: "ğŸ¨ 1 Ø³Ø§Ø¹Ø© ØªØ±ÙÙŠÙ‡ÙŠØ© ÙŠÙˆÙ…ÙŠØ©:",
                methodologyHeading: "ğŸ“˜ Ø§Ù„Ù…Ù†Ù‡Ø¬ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:",
                methodologyDescriptionText: "McMillion Ø§Ù„Ù…Ø¹ØªÙ…Ø¯ Ø¹Ø§Ù„Ù…ÙŠÙ‹Ø§ØŒ Ù…ØµÙ…Ù… Ø®ØµÙŠØµÙ‹Ø§ Ù„Ù„Ø£Ø·ÙØ§Ù„ Ù„ÙŠØ±Ø§Ø¹ÙŠ Ù…Ø³ØªÙˆÙŠØ§ØªÙ‡Ù… ÙˆÙŠØ·ÙˆÙ‘Ø± Ù…Ù‡Ø§Ø±Ø§ØªÙ‡Ù… Ø§Ù„Ø£Ø±Ø¨Ø¹:\n(Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ â€“ Ø§Ù„ØªØ­Ø¯Ø« â€“ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© â€“ Ø§Ù„ÙƒØªØ§Ø¨Ø©)",
                durationTextContent: "ğŸ—“ï¸ Ø§Ù„Ù…Ø¯Ø©: 6 Ø£Ø³Ø§Ø¨ÙŠØ¹ Ù…ØªÙƒØ§Ù…Ù„Ø©",
                datesTextContent: "ğŸ“† Ù…Ù† 1 ÙŠÙˆÙ†ÙŠÙˆ Ø¥Ù„Ù‰ 15 ÙŠÙˆÙ„ÙŠÙˆ 2025",
                locationTextContent: "ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹: ØªØ§Ø¬ÙˆØ±Ø§Ø¡ â€“ Ø®Ù„Ù Ù…Ù†ØªØ²Ù‡ Ø§Ù„Ø³Ù†Ø¯Ø¨Ø§Ø¯",
                contactPhoneDisplay: "ğŸ“ Ù„Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØ§Ù„Ø§Ø³ØªÙØ³Ø§Ø±: 0929272725",
                ourGoalHeadingText: "ğŸš¸ Ù‡Ø¯ÙÙ†Ø§:",
                ourGoalDescriptionText: "Ø£Ù† Ù†ØºÙŠÙ‘Ø± Ù†Ø¸Ø±Ø© Ø§Ù„Ø·ÙÙ„ Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©ØŒ\nÙ…Ù† \"Ù…Ø§Ø¯Ø© Ø¯Ø±Ø§Ø³ÙŠØ©\" Ø¥Ù„Ù‰ \"Ù…Ù‡Ø§Ø±Ø© Ù…Ù…ØªØ¹Ø© ÙˆÙ‚ÙˆÙŠØ©\" ÙŠØ¹ÙŠØ´Ù‡Ø§ ÙŠÙˆÙ…ÙŠÙ‹Ø§.",
                limitedSeatsTextContent: "ğŸ“Œ Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯ Ù…Ø­Ø¯ÙˆØ¯Ø© Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¬ÙˆØ¯Ø©... Ù„Ø§ ØªØªØ±Ø¯Ø¯!",
                bottomContactInfoText: "Ù„Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙˆØ§Ù„ØªØ³Ø¬ÙŠÙ„ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù†Ø§:",
                bottomPhoneTextContent: "Ø§Ù„Ù‡Ø§ØªÙ: 0929272725",
                hashtagsTextContent: "#Ù…Ø®ÙŠÙ…_Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© #ØµÙŠÙ_2025 #EnglishForKids #Ø·Ø±Ø§Ø¨Ù„Ø³ #ØªØ¹Ù„ÙŠÙ…_ÙˆØªØ±ÙÙŠÙ‡ #TripoliSummerCamp",
                sliderPhrases: [
                    "Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©: Ù…ÙØªØ§Ø­ Ø·ÙÙ„Ùƒ Ù†Ø­Ùˆ Ø¹Ø§Ù„Ù… Ø£ÙˆØ³Ø¹!",
                    "Ø§Ø¬Ø¹Ù„ ØªØ¹Ù„Ù… Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ù…ØºØ§Ù…Ø±Ø© Ù…Ù…ØªØ¹Ø© Ù„Ø·ÙÙ„Ùƒ!",
                    "Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø«Ù‚Ø© ÙÙŠ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©ØŒ Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ©.",
                    "ØµÙŠÙ Ù…Ù„ÙŠØ¡ Ø¨Ø§Ù„Ù…Ø±Ø­ ÙˆØ§Ù„ØªØ¹Ù„Ù…... Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©!",
                    "Ù…Ø³ØªÙ‚Ø¨Ù„ Ø·ÙÙ„Ùƒ ÙŠØ¨Ø¯Ø£ Ø¨Ø¥ØªÙ‚Ø§Ù† Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©."
                ]
            }
        };

        const modal = document.getElementById('myModal');
        const modalMessage = document.getElementById('modalMessage');
        const closeButton = document.getElementsByClassName('close-button')[0];
        const previewIframe = document.getElementById('previewIframe');
        const registeredStudentsAdminList = document.getElementById('registeredStudentsAdminList');

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                console.log("User authenticated:", currentUserId);
                loadAdminSettings();
                loadRegistrations();
            } else {
                console.log("No user authenticated, signing in anonymously.");
                signInAnonymously(auth).then(anonUser => {
                    currentUserId = anonUser.user.uid;
                    console.log("Signed in anonymously:", currentUserId);
                    loadAdminSettings();
                    loadRegistrations();
                }).catch(error => {
                    console.error("Anonymous sign-in failed:", error);
                    showModal("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©. Ù‚Ø¯ Ù„Ø§ ØªØ¹Ù…Ù„ Ø¨Ø¹Ø¶ Ø§Ù„Ù…ÙŠØ²Ø§Øª.");
                });
            }
        });

        function showModal(message) {
            modalMessage.textContent = message;
            modal.style.display = 'flex';
        }

        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') {
                return unsafe;
            }
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;")
                .replace(/`/g, '\\`')
                .replace(/\$/g, '\\$');
        }

        const adminSettingsDocRef = doc(db, `artifacts/${appId}/public/data/admin_settings`, 'config');

        function applySettings(settings) {
            if (settings.colors) {
                document.documentElement.style.setProperty('--body-bg', settings.colors.bodyBg);
                document.documentElement.style.setProperty('--header-gradient-start', settings.colors.headerGradientStart);
                document.documentElement.style.setProperty('--header-gradient-end', settings.colors.headerGradientEnd);
                document.documentElement.style.setProperty('--feature-icon-color', settings.colors.featureIconColor);
                document.documentElement.style.setProperty('--form-submit-button-start', settings.colors.formSubmitButtonStart);
                document.documentElement.style.setProperty('--form-submit-button-end', settings.colors.formSubmitButtonEnd);
            }

            document.getElementById('logoUrlInput').value = settings.logoUrl || '';
            document.getElementById('bodyBgColorInput').value = settings.colors.bodyBg || defaultSettings.colors.bodyBg;
            document.getElementById('headerGradientStartInput').value = settings.colors.headerGradientStart || defaultSettings.colors.headerGradientStart;
            document.getElementById('headerGradientEndInput').value = settings.colors.headerGradientEnd || defaultSettings.colors.headerGradientEnd;
            document.getElementById('featureIconColorInput').value = settings.colors.featureIconColor || defaultSettings.colors.featureIconColor;
            document.getElementById('formSubmitButtonStartInput').value = settings.colors.formSubmitButtonStart || defaultSettings.colors.formSubmitButtonStart;
            document.getElementById('formSubmitButtonEndInput').value = settings.colors.formSubmitButtonEnd || defaultSettings.colors.formSubmitButtonEnd;

            document.getElementById('mainTitleInput').value = settings.texts.mainTitle || '';
            document.getElementById('campSloganInput').value = settings.texts.campSlogan || '';
            document.getElementById('campNameInput').value = settings.texts.campName || '';
            document.getElementById('registrationStatusInput').value = settings.texts.registrationStatus || '';
            document.getElementById('programIntroInput').value = settings.texts.programIntro || '';
            document.getElementById('programHeadingInput').value = settings.texts.programHeading || '';
            document.getElementById('educationalHoursHeadingInput').value = settings.texts.educationalHoursHeading || '';
            document.getElementById('recreationalHoursHeadingInput').value = settings.texts.recreationalHoursHeading || '';
            document.getElementById('methodologyHeadingInput').value = settings.texts.methodologyHeading || '';
            document.getElementById('methodologyDescriptionInput').value = settings.texts.methodologyDescriptionText || '';
            document.getElementById('durationTextInput').value = settings.texts.durationTextContent || '';
            document.getElementById('datesTextInput').value = settings.texts.datesTextContent || '';
            document.getElementById('locationTextInput').value = settings.texts.locationTextContent || '';
            document.getElementById('contactPhoneDisplayInput').value = settings.texts.contactPhoneDisplay || '';
            document.getElementById('ourGoalHeadingTextInput').value = settings.texts.ourGoalHeadingText || '';
            document.getElementById('ourGoalDescriptionTextInput').value = settings.texts.ourGoalDescriptionText || '';
            document.getElementById('limitedSeatsTextInput').value = settings.texts.limitedSeatsTextContent || '';
            document.getElementById('bottomContactInfoTextInput').value = settings.texts.bottomContactInfoText || '';
            document.getElementById('bottomPhoneTextInput').value = settings.texts.bottomPhoneTextContent || '';
            document.getElementById('hashtagsTextInput').value = settings.texts.hashtagsTextContent || '';

            for (let i = 0; i < 5; i++) {
                const input = document.getElementById(`sliderPhrase${i + 1}Input`);
                if (input) {
                    input.value = (settings.texts.sliderPhrases && settings.texts.sliderPhrases[i]) || '';
                }
            }
        }

        function loadAdminSettings() {
            onSnapshot(adminSettingsDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const settings = docSnap.data();
                    console.log("Admin settings loaded:", settings);
                    applySettings(settings);
                    sendSettingsToPreview(settings);
                } else {
                    console.log("No admin settings found, using default.");
                    applySettings(defaultSettings);
                    sendSettingsToPreview(defaultSettings);
                }
            }, (error) => {
                console.error("Error listening to admin settings:", error);
                showModal("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª. Ù‚Ø¯ Ù„Ø§ ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.");
            });
        }

        async function saveAdminSettings() {
            const newSettings = {
                logoUrl: document.getElementById('logoUrlInput').value,
                colors: {
                    bodyBg: document.getElementById('bodyBgColorInput').value,
                    headerGradientStart: document.getElementById('headerGradientStartInput').value,
                    headerGradientEnd: document.getElementById('headerGradientEndInput').value,
                    featureIconColor: document.getElementById('featureIconColorInput').value,
                    formSubmitButtonStart: document.getElementById('formSubmitButtonStartInput').value,
                    formSubmitButtonEnd: document.getElementById('formSubmitButtonEndInput').value
                },
                texts: {
                    mainTitle: document.getElementById('mainTitleInput').value,
                    campSlogan: document.getElementById('campSloganInput').value,
                    campName: document.getElementById('campNameInput').value,
                    registrationStatus: document.getElementById('registrationStatusInput').value,
                    programIntro: document.getElementById('programIntroInput').value,
                    programHeading: document.getElementById('programHeadingInput').value,
                    educationalHoursHeading: document.getElementById('educationalHoursHeadingInput').value,
                    recreationalHoursHeading: document.getElementById('recreationalHoursHeadingInput').value,
                    methodologyHeading: document.getElementById('methodologyHeadingInput').value,
                    methodologyDescriptionText: document.getElementById('methodologyDescriptionInput').value,
                    durationTextContent: document.getElementById('durationTextInput').value,
                    datesTextContent: document.getElementById('datesTextInput').value,
                    locationTextContent: document.getElementById('locationTextInput').value,
                    contactPhoneDisplay: document.getElementById('contactPhoneDisplayInput').value,
                    ourGoalHeadingText: document.getElementById('ourGoalHeadingTextInput').value,
                    ourGoalDescriptionText: document.getElementById('ourGoalDescriptionTextInput').value,
                    limitedSeatsTextContent: document.getElementById('limitedSeatsTextInput').value,
                    bottomContactInfoText: document.getElementById('bottomContactInfoTextInput').value,
                    bottomPhoneTextContent: document.getElementById('bottomPhoneTextInput').value,
                    hashtagsTextContent: document.getElementById('hashtagsTextInput').value,
                    sliderPhrases: [
                        document.getElementById('sliderPhrase1Input').value,
                        document.getElementById('sliderPhrase2Input').value,
                        document.getElementById('sliderPhrase3Input').value,
                        document.getElementById('sliderPhrase4Input').value,
                        document.getElementById('sliderPhrase5Input').value
                    ].filter(phrase => phrase.trim() !== '')
                }
            };

            try {
                await setDoc(adminSettingsDocRef, newSettings);
                console.log("Admin settings saved successfully!");
                showModal("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!");
            } catch (error) {
                console.error("Error saving admin settings:", error);
                showModal("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.");
            }
        }

        function applySettingsFromInputs() {
            const currentSettings = {
                logoUrl: document.getElementById('logoUrlInput').value,
                colors: {
                    bodyBg: document.getElementById('bodyBgColorInput').value,
                    headerGradientStart: document.getElementById('headerGradientStartInput').value,
                    headerGradientEnd: document.getElementById('headerGradientEndInput').value,
                    featureIconColor: document.getElementById('featureIconColorInput').value,
                    formSubmitButtonStart: document.getElementById('formSubmitButtonStartInput').value,
                    formSubmitButtonEnd: document.getElementById('formSubmitButtonEndInput').value
                },
                texts: {
                    mainTitle: document.getElementById('mainTitleInput').value,
                    campSlogan: document.getElementById('campSloganInput').value,
                    campName: document.getElementById('campNameInput').value,
                    registrationStatus: document.getElementById('registrationStatusInput').value,
                    programIntro: document.getElementById('programIntroInput').value,
                    programHeading: document.getElementById('programHeadingInput').value,
                    educationalHoursHeading: document.getElementById('educationalHoursHeadingInput').value,
                    recreationalHoursHeading: document.getElementById('recreationalHoursHeadingInput').value,
                    methodologyHeading: document.getElementById('methodologyHeadingInput').value,
                    methodologyDescriptionText: document.getElementById('methodologyDescriptionInput').value,
                    durationTextContent: document.getElementById('durationTextInput').value,
                    datesTextContent: document.getElementById('datesTextInput').value,
                    locationTextContent: document.getElementById('locationTextInput').value,
                    contactPhoneDisplay: document.getElementById('contactPhoneDisplayInput').value,
                    ourGoalHeadingText: document.getElementById('ourGoalHeadingTextInput').value,
                    ourGoalDescriptionText: document.getElementById('ourGoalDescriptionTextInput').value,
                    limitedSeatsTextContent: document.getElementById('limitedSeatsTextInput').value,
                    bottomContactInfoText: document.getElementById('bottomContactInfoTextInput').value,
                    bottomPhoneTextContent: document.getElementById('bottomPhoneTextInput').value,
                    hashtagsTextContent: document.getElementById('hashtagsTextInput').value,
                    sliderPhrases: [
                        document.getElementById('sliderPhrase1Input').value,
                        document.getElementById('sliderPhrase2Input').value,
                        document.getElementById('sliderPhrase3Input').value,
                        document.getElementById('sliderPhrase4Input').value,
                        document.getElementById('sliderPhrase5Input').value
                    ].filter(phrase => phrase.trim() !== '')
                }
            };
            sendSettingsToPreview(currentSettings);
        }

        function sendSettingsToPreview(settings) {
            if (previewIframe.contentWindow) {
                previewIframe.contentWindow.postMessage({
                    type: 'updatePreviewSettings',
                    settings: settings
                }, '*');
            }
        }

        // The srcdoc content for the iframe, mimicking the index.html structure
        previewIframe.srcdoc = `
            <!DOCTYPE html>
            <html lang="ar" dir="rtl">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</title>
                <script src="https://cdn.tailwindcss.com"></script>
                <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
                <style>
                    :root {
                        --body-bg: #E6F0F5;
                        --header-gradient-start: #3F72AF;
                        --header-gradient-end: #112D4E;
                        --feature-icon-color: #3B82F6;
                        --form-submit-button-start: #3B82F6;
                        --form-submit-button-end: #2563EB;
                    }
                    body {
                        font-family: 'Cairo', sans-serif;
                        background-color: var(--body-bg);
                        display: flex;
                        justify-content: center;
                        align-items: flex-start;
                        min-height: 100vh;
                        padding: 10px; /* Reduced padding for smaller side margins */
                        overflow-y: auto;
                    }
                    .ad-container {
                        background-color: #ffffff;
                        border-radius: 0.75rem;
                        box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
                        max-width: 300px;
                        width: 100%;
                        overflow: hidden;
                        text-align: center;
                        display: flex;
                        flex-direction: column;
                        transform: scale(0.9);
                        transform-origin: top center;
                    }
                    .header-bg {
                        background: linear-gradient(to right, var(--header-gradient-start), var(--header-gradient-end));
                        padding: 1rem 1rem;
                        color: white;
                        position: relative;
                        overflow: hidden;
                        border-radius: 0.75rem; /* Unified border-radius for the header in preview */
                    }
                    .header-bg::before {
                        content: '';
                        position: absolute;
                        top: -50%;
                        left: -50%;
                        width: 200%;
                        height: 200%;
                        background: radial-gradient(circle at center, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
                        animation: pulse-light 5s infinite ease-in-out;
                    }
                    @keyframes pulse-light {
                        0% { transform: scale(0.8) rotate(0deg); opacity: 0.5; }
                        50% { transform: scale(1.2) rotate(10deg); opacity: 0.8; }
                        100% { transform: scale(0.8) rotate(0deg); opacity: 0.5; }
                    }
                    .content-section {
                        padding: 1rem 1rem;
                        font-size: 0.8rem;
                    }
                    .cta-button {
                        background: linear-gradient(to right, #10b981, #059669);
                        color: white;
                        padding: 0.5rem 1rem;
                        border-radius: 0.5rem;
                        font-weight: 700;
                        font-size: 0.9rem;
                        display: inline-block;
                        margin-top: 1rem;
                    }
                    .feature-item {
                        display: flex;
                        align-items: flex-start;
                        justify-content: flex-end;
                        gap: 0.5rem;
                        margin-bottom: 0.5rem;
                        font-size: 0.8rem;
                        color: #4b5563;
                        text-align: right;
                    }
                    .feature-icon {
                        color: var(--feature-icon-color);
                        font-size: 1.2rem;
                        flex-shrink: 0;
                    }
                    .school-logo {
                        width: 80px;
                        height: auto;
                        margin-bottom: 0.5rem;
                        display: block;
                        margin-left: auto;
                        margin-right: auto;
                    }
                    /* Slider related styles removed for preview iframe as well */
                    .slider-container, .slides, .slide, .slider-nav-btn, .slider-dots {
                        display: none;
                    }
                    h1, h2, h3, p {
                        line-height: normal;
                    }
                    .registration-form-section, .slogan-generator-section {
                        padding: 1rem;
                        margin-top: 1.5rem;
                    }
                    .form-group label, .form-group input, .form-group select, .form-group textarea {
                        font-size: 0.8rem;
                        padding: 0.5rem;
                    }
                    .form-submit-button {
                        padding: 0.5rem 1rem;
                        font-size: 0.9rem;
                    }
                    @media (min-width: 640px) {
                        .ad-container {
                            flex-direction: row;
                            text-align: right;
                            border-radius: 0.75rem;
                        }
                        .header-bg {
                            flex: 1;
                            border-radius: 0.75rem; /* Unified border-radius for the header */
                        }
                        .content-section {
                            flex: 2;
                            border-radius: 0.75rem; /* Unified border-radius for content */
                        }
                    }
                </style>
            </head>
            <body>
                <div class="ad-container">
                    <div class="header-bg">
                        <img id="schoolLogoPreview" src="" alt="Ø´Ø¹Ø§Ø± Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ©" class="school-logo">
                        <h1 class="text-xl font-extrabold mb-2" id="mainTitleTextPreview"></h1>
                        <p class="text-base font-semibold mb-1" id="campSloganTextPreview"></p>
                        <p class="text-sm font-medium" id="campNameTextPreview"></p>
                        <p class="text-sm font-medium" id="registrationStatusTextPreview"></p>
                    </div>
                    <div class="content-section">
                        <h2 class="text-lg font-bold text-gray-800 mb-3" id="programHeadingTextPreview"></h2>
                        <p class="text-gray-600 mb-2" id="programIntroTextPreview"></p>
                        <div class="text-right mb-4">
                            <p class="text-gray-700 font-bold text-base mb-2" id="educationalHoursHeadingTextPreview"></p>
                            <ul class="list-none pr-0">
                                <li class="feature-item"><span class="feature-icon">ğŸ—£ï¸</span><span id="eduFeature1Preview">Ù…Ø­Ø§Ø¯Ø«Ø© Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù…Ø¹ Ù…Ø¯Ø±Ø³ÙŠÙ† Ù…Ø­ØªØ±ÙÙŠÙ†</span></li>
                                <li class="feature-item"><span class="feature-icon">âœï¸</span><span id="eduFeature2Preview">Ø£Ù†Ø´Ø·Ø© Ù‚Ø±Ø§Ø¡Ø© ÙˆÙƒØªØ§Ø¨Ø© ÙˆÙÙ‚ Ù…Ù†Ù‡Ø¬ McMillion Ø§Ù„Ø¯ÙˆÙ„ÙŠ</span></li>
                                <li class="feature-item"><span class="feature-icon">ğŸ²</span><span id="eduFeature3Preview">Ø£Ù„Ø¹Ø§Ø¨ ØªØ¹Ù„ÙŠÙ…ÙŠØ© ØªØ­ÙÙ‘Ø² Ø§Ù„ØªÙØ§Ø¹Ù„ ÙˆØªÙ†Ù…Ù‘ÙŠ Ø§Ù„Ø«Ù‚Ø©</span></li>
                            </ul>
                        </div>
                        <div class="text-right mb-4">
                            <p class="text-gray-700 font-bold text-base mb-2" id="recreationalHoursHeadingTextPreview"></p>
                            <ul class="list-none pr-0">
                                <li class="feature-item"><span class="feature-icon">ğŸŠ</span><span id="recFeature1Preview">Ø£ÙŠØ§Ù… Ø³Ø¨Ø§Ø­Ø© Ù…Ø±Ø­Ø©</span></li>
                                <li class="feature-item"><span class="feature-icon">ğŸ–Œï¸</span><span id="recFeature2Preview">ÙˆØ±Ø´ ÙÙ†ÙŠØ© ÙˆØ¥Ø¨Ø¯Ø§Ø¹ÙŠØ©</span></li>
                                <li class="feature-item"><span class="feature-icon">ğŸ¬</span><span id="recFeature3Preview">Ø¹Ø±ÙˆØ¶ Ø³ÙŠÙ†Ù…Ø§ ØªØ¹Ù„ÙŠÙ…ÙŠØ©</span></li>
                                <li class="feature-item"><span class="feature-icon">ğŸ¤</span><span id="recFeature4Preview">Ø£Ù„Ø¹Ø§Ø¨ Ø¬Ù…Ø§Ø¹ÙŠØ© Ù„ØªØ¹Ø²ÙŠØ² Ø±ÙˆØ­ Ø§Ù„ÙØ±ÙŠÙ‚</span></li>
                            </ul>
                        </div>
                        <div class="text-right mb-4">
                            <h3 class="text-base font-bold text-gray-800 mb-2" id="methodologyHeadingTextPreview"></h3>
                            <p class="text-gray-600" id="methodologyDescriptionTextPreview"></p>
                        </div>
                        <div class="text-right mb-4">
                            <p class="text-gray-700 font-bold text-base mb-1" id="durationTextContentPreview"></p>
                            <p class="text-gray-700 font-bold text-base mb-1" id="datesTextContentPreview"></p>
                            <p class="text-gray-700 font-bold text-base mb-1" id="locationTextContentPreview"></p>
                            <p class="text-gray-700 font-bold text-base mb-1" id="contactPhoneDisplayPreview"></p>
                        </div>
                        <div class="text-right mb-4">
                            <h3 class="text-base font-bold text-gray-800 mb-2" id="ourGoalHeadingTextPreview"></h3>
                            <p class="text-gray-600" id="ourGoalDescriptionTextPreview"></p>
                        </div>
                        <p class="text-gray-700 font-semibold mb-2 text-base" id="limitedSeatsTextContentPreview"></p>
                        <a href="register.html" class="cta-button">Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù†!</a>
                        <div class="mt-4 text-gray-500 text-xs">
                            <p id="bottomContactInfoTextPreview"></p>
                            <p id="bottomPhoneTextContentPreview"></p>
                            <p id="hashtagsTextContentPreview"></p>
                        </div>
                    </div>
                </div>
                <script>
                    function escapeHtml(unsafe) {
                        if (typeof unsafe !== 'string') {
                            return unsafe;
                        }
                        return unsafe
                            .replace(/&/g, "&amp;")
                            .replace(/</g, "&lt;")
                            .replace(/>/g, "&gt;")
                            .replace(/"/g, "&quot;")
                            .replace(/'/g, "&#039;");
                    }

                    window.addEventListener('message', (event) => {
                        if (event.data && event.data.type === 'updatePreviewSettings') {
                            const settings = event.data.settings;
                            const root = document.documentElement;

                            root.style.setProperty('--body-bg', settings.colors.bodyBg);
                            root.style.setProperty('--header-gradient-start', settings.colors.headerGradientStart);
                            root.style.setProperty('--header-gradient-end', settings.colors.headerGradientEnd);
                            root.style.setProperty('--feature-icon-color', settings.colors.featureIconColor);
                            root.style.setProperty('--form-submit-button-start', settings.colors.formSubmitButtonStart);
                            root.style.setProperty('--form-submit-button-end', settings.colors.formSubmitButtonEnd);

                            document.getElementById('schoolLogoPreview').src = settings.logoUrl;

                            document.getElementById('mainTitleTextPreview').textContent = settings.texts.mainTitle || '';
                            document.getElementById('campSloganTextPreview').textContent = settings.texts.campSlogan || '';
                            document.getElementById('campNameTextPreview').textContent = settings.texts.campName || '';
                            document.getElementById('registrationStatusTextPreview').textContent = settings.texts.registrationStatus || '';
                            document.getElementById('programIntroTextPreview').textContent = settings.texts.programIntro || '';
                            document.getElementById('programHeadingTextPreview').textContent = settings.texts.programHeading || '';
                            document.getElementById('educationalHoursHeadingTextPreview').textContent = settings.texts.educationalHoursHeading || '';
                            document.getElementById('recreationalHoursHeadingTextPreview').textContent = settings.texts.recreationalHoursHeading || '';
                            document.getElementById('methodologyHeadingTextPreview').textContent = settings.texts.methodologyHeading || '';
                            document.getElementById('methodologyDescriptionTextPreview').textContent = settings.texts.methodologyDescriptionText || '';
                            document.getElementById('durationTextContentPreview').textContent = settings.texts.durationTextContent || '';
                            document.getElementById('datesTextContentPreview').textContent = settings.texts.datesTextContent || '';
                            document.getElementById('locationTextContentPreview').textContent = settings.texts.locationTextContent || '';
                            document.getElementById('contactPhoneDisplayPreview').textContent = settings.texts.contactPhoneDisplay || '';
                            document.getElementById('ourGoalHeadingTextPreview').textContent = settings.texts.ourGoalHeadingText || '';
                            document.getElementById('ourGoalDescriptionTextPreview').textContent = settings.texts.ourGoalDescriptionText || '';
                            document.getElementById('limitedSeatsTextContentPreview').textContent = settings.texts.limitedSeatsTextContent || '';
                            document.getElementById('bottomContactInfoTextPreview').textContent = settings.texts.bottomContactInfoText || '';
                            document.getElementById('bottomPhoneTextContentPreview').textContent = settings.texts.bottomPhoneTextContent || '';
                            document.getElementById('hashtagsTextContentPreview').textContent = settings.texts.hashtagsTextContent || '';
                        }
                    });
                </script>
            </body>
            </html>
        `;

        function getRegistrationsCollectionRef() {
            if (!currentUserId) {
                console.error("User ID is not available for Firestore operations.");
                return null;
            }
            return collection(db, `artifacts/${appId}/public/data/registrations`);
        }

        function renderRegisteredStudents(students, targetElement) {
            targetElement.innerHTML = '';
            if (students.length === 0) {
                targetElement.innerHTML = '<p class="text-gray-500">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù…Ø³Ø¬Ù„ÙˆÙ† Ø­Ø§Ù„ÙŠØ§Ù‹.</p>';
                return;
            }

            students.forEach(student => {
                const studentCard = document.createElement('div');
                studentCard.className = `student-card ${student.contacted ? 'contacted' : ''}`;
                studentCard.innerHTML = `
                    <h4>${escapeHtml(student.name)}</h4>
                    <p>Ø§Ù„Ø¹Ù…Ø±: ${escapeHtml(student.age)}</p>
                    <p>Ø§Ù„Ù…Ø³ØªÙˆÙ‰: ${escapeHtml(student.englishLevel)}</p>
                    <p>Ø§Ù„Ù‚Ø³Ù…: ${escapeHtml(student.section)}</p>
                    <p>Ù‡Ø§ØªÙ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±: <span dir="ltr">${escapeHtml(student.parentPhone)}</span></p>
                    ${student.label ? `<span class="label-display">${escapeHtml(student.label)}</span>` : ''}
                    <div class="actions">
                        <button class="toggle-contacted ${student.contacted ? 'contacted' : ''}" data-id="${student.id}" data-contacted="${student.contacted}">
                            ${student.contacted ? 'ØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ âœ…' : 'Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ âŒ'}
                        </button>
                        <select class="label-select" data-id="${student.id}">
                            <option value="">Ø§Ø®ØªØ± ØªØµÙ†ÙŠÙ</option>
                            <option value="Ù…Ù‡ØªÙ…" ${student.label === 'Ù…Ù‡ØªÙ…' ? 'selected' : ''}>Ù…Ù‡ØªÙ…</option>
                            <option value="ØªÙ… Ø§Ù„Ø¯ÙØ¹" ${student.label === 'ØªÙ… Ø§Ù„Ø¯ÙØ¹' ? 'selected' : ''}>ØªÙ… Ø§Ù„Ø¯ÙØ¹</option>
                            <option value="Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø±Ø¯" ${student.label === 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø±Ø¯' ? 'selected' : ''}>Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø±Ø¯</option>
                            <option value="Ù…Ù„ØºÙŠ" ${student.label === 'Ù…Ù„ØºÙŠ' ? 'selected' : ''}>Ù…Ù„ØºÙŠ</option>
                        </select>
                        <button class="delete-btn" data-id="${student.id}">Ø­Ø°Ù</button>
                    </div>
                `;
                targetElement.appendChild(studentCard);
            });

            targetElement.querySelectorAll('.toggle-contacted').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const id = e.target.dataset.id;
                    const contacted = e.target.dataset.contacted === 'true';
                    const regDocRef = doc(getRegistrationsCollectionRef(), id);
                    await updateDoc(regDocRef, { contacted: !contacted });
                });
            });

            targetElement.querySelectorAll('.label-select').forEach(select => {
                select.addEventListener('change', async (e) => {
                    const id = e.target.dataset.id;
                    const label = e.target.value;
                    const regDocRef = doc(getRegistrationsCollectionRef(), id);
                    await updateDoc(regDocRef, { label: label });
                });
            });

            targetElement.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const id = e.target.dataset.id;
                    const regDocRef = doc(getRegistrationsCollectionRef(), id);
                    // Using a custom modal for confirmation instead of window.confirm
                    showConfirmationModal('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ØŸ', async () => {
                        await deleteDoc(regDocRef);
                        showModal('ØªÙ… Ø­Ø°Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­.');
                    });
                });
            });
        }

        // Custom Confirmation Modal
        function showConfirmationModal(message, onConfirm) {
            const confirmationModal = document.createElement('div');
            confirmationModal.className = 'modal';
            confirmationModal.innerHTML = `
                <div class="modal-content">
                    <p class="text-lg font-semibold text-gray-800">${message}</p>
                    <div class="flex justify-center gap-4 mt-4">
                        <button id="confirmYes" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">Ù†Ø¹Ù…</button>
                        <button id="confirmNo" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">Ù„Ø§</button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmationModal);
            confirmationModal.style.display = 'flex';

            document.getElementById('confirmYes').onclick = () => {
                onConfirm();
                document.body.removeChild(confirmationModal);
            };
            document.getElementById('confirmNo').onclick = () => {
                document.body.removeChild(confirmationModal);
            };
            confirmationModal.onclick = (event) => {
                if (event.target === confirmationModal) {
                    document.body.removeChild(confirmationModal);
                }
            };
        }


        function loadRegistrations() {
            const registrationsColRef = getRegistrationsCollectionRef();
            if (!registrationsColRef) return;

            onSnapshot(registrationsColRef, (snapshot) => {
                const registrations = [];
                snapshot.forEach(doc => {
                    registrations.push({ id: doc.id, ...doc.data() });
                });
                console.log("Registrations loaded:", registrations);
                renderRegisteredStudents(registrations, registeredStudentsAdminList);
            }, (error) => {
                console.error("Error listening to registrations:", error);
            });
        }


        closeButton.onclick = function() {
            modal.style.display = 'none';
        }

        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        document.getElementById('saveSettingsBtn').addEventListener('click', saveAdminSettings);
        document.getElementById('applySettingsBtn').addEventListener('click', applySettingsFromInputs);

        document.querySelectorAll('#adminDashboard input, #adminDashboard textarea, #adminDashboard select').forEach(input => {
            input.addEventListener('input', () => {
                const currentSettings = {
                    logoUrl: document.getElementById('logoUrlInput').value,
                    colors: {
                        bodyBg: document.getElementById('bodyBgColorInput').value,
                        headerGradientStart: document.getElementById('headerGradientStartInput').value,
                        headerGradientEnd: document.getElementById('headerGradientEndInput').value,
                        featureIconColor: document.getElementById('featureIconColorInput').value,
                        formSubmitButtonStart: document.getElementById('formSubmitButtonStartInput').value,
                        formSubmitButtonEnd: document.getElementById('formSubmitButtonEndInput').value
                    },
                    texts: {
                        mainTitle: document.getElementById('mainTitleInput').value,
                        campSlogan: document.getElementById('campSloganInput').value,
                        campName: document.getElementById('campNameInput').value,
                        registrationStatus: document.getElementById('registrationStatusInput').value,
                        programIntro: document.getElementById('programIntroInput').value,
                        programHeading: document.getElementById('programHeadingInput').value,
                        educationalHoursHeading: document.getElementById('educationalHoursHeadingInput').value,
                        recreationalHoursHeading: document.getElementById('recreationalHoursHeadingInput').value,
                        methodologyHeading: document.getElementById('methodologyHeadingInput').value,
                        methodologyDescriptionText: document.getElementById('methodologyDescriptionInput').value,
                        durationTextContent: document.getElementById('durationTextInput').value,
                        datesTextContent: document.getElementById('datesTextInput').value,
                        locationTextContent: document.getElementById('locationTextInput').value,
                        contactPhoneDisplay: document.getElementById('contactPhoneDisplayInput').value,
                        ourGoalHeadingText: document.getElementById('ourGoalHeadingTextInput').value,
                        ourGoalDescriptionText: document.getElementById('ourGoalDescriptionTextInput').value,
                        limitedSeatsTextContent: document.getElementById('limitedSeatsTextInput').value,
                        bottomContactInfoText: document.getElementById('bottomContactInfoTextInput').value,
                        bottomPhoneTextContent: document.getElementById('bottomPhoneTextInput').value,
                        hashtagsTextContent: document.getElementById('hashtagsTextInput').value,
                        sliderPhrases: [
                            document.getElementById('sliderPhrase1Input').value,
                            document.getElementById('sliderPhrase2Input').value,
                            document.getElementById('sliderPhrase3Input').value,
                            document.getElementById('sliderPhrase4Input').value,
                            document.getElementById('sliderPhrase5Input').value
                        ].filter(phrase => phrase.trim() !== '')
                    }
                };
                sendSettingsToPreview(currentSettings);
            });
        });

        // Initial population of slider phrase inputs in dashboard
        document.addEventListener('DOMContentLoaded', () => {
            for (let i = 0; i < 5; i++) {
                const input = document.getElementById(`sliderPhrase${i + 1}Input`);
                if (input) {
                    input.value = defaultSettings.texts.sliderPhrases[i] || '';
                }
            }
        });
    </script>
</body>
</html>
